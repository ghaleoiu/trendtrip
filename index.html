<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TrendTrip | 서울 구 단위 자동 코스 (예산 최적화)</title>
  <meta name="description" content="서울 구 단위로 숙소까지 포함된 자동 여행 코스를 2~3가지 제안하며, 큰 예산일수록 고급으로 업그레이드합니다." />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root{ --brand:#0ea5e9 }
    html,body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif}
    .card{border-radius:1.25rem;box-shadow:0 8px 30px rgba(2,132,199,.08);padding:1rem;background:#fff}
    .btn{padding:.6rem 1rem;border-radius:.9rem;font-weight:700;transition:.12s;display:inline-flex;align-items:center;gap:.5rem}
    .btn:hover{transform:translateY(-1px)}
    .btn-primary{background:var(--brand);color:#fff}
    .btn-outline{background:#fff;border:1px solid #e5e7eb}
    .badge{padding:.22rem .55rem;border-radius:.5rem;background:#f1f5f9;font-size:.72rem}
    .pill{padding:.35rem .7rem;border:1px solid #e5e7eb;border-radius:999px;font-size:.8rem}
    .route-color-1{color:#0ea5e9}
    .route-color-2{color:#22c55e}
    .route-color-3{color:#f59e0b}
  </style>
</head>
<body class="bg-gradient-to-b from-sky-50 via-white to-white text-gray-800">

  <header class="sticky top-0 z-40">
    <div class="max-w-6xl mx-auto my-3 px-4 py-3 flex items-center justify-between bg-white/70 backdrop-blur rounded-xl border">
      <div class="font-extrabold text-lg flex items-center gap-2"><span class="text-2xl">🧭</span> TrendTrip</div>
      <div class="text-sm text-gray-500">서울 · 구 단위 자동 코스(예산 최적화)</div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 pb-10 grid md:grid-cols-3 gap-6">
    <!-- 좌측: 설정 -->
    <section class="md:col-span-1 space-y-4">
      <div class="card">
        <div class="badge mb-2">여행 설정</div>
        <label class="block text-sm mb-1">서울 구 선택</label>
        <select id="district" class="w-full border rounded-xl px-3 py-2">
          <option value="4"  data-center="37.5639,127.0364">성동구</option>
          <option value="5"  data-center="37.5387,127.0822">광진구</option>
          <option value="1"  data-center="37.5733,126.9793">종로구</option>
          <option value="2"  data-center="37.5636,126.9976">중구</option>
          <option value="3"  data-center="37.5326,126.9905">용산구</option>
        </select>

        <div class="grid grid-cols-2 gap-2 mt-3">
          <div>
            <label class="block text-sm mb-1">여행 유형</label>
            <select id="tripMode" class="w-full border rounded-xl px-3 py-2">
              <option value="6h">6시간 당일</option>
              <option value="1n2d">1박 2일</option>
              <option value="2n3d">2박 3일</option>
            </select>
          </div>
          <div>
            <label class="block text-sm mb-1">총 예산(₩)</label>
            <input id="budget" type="number" class="w-full border rounded-xl px-3 py-2" value="300000" />
          </div>
        </div>

        <div class="grid grid-cols-2 gap-2 mt-3">
          <div>
            <label class="block text-sm mb-1">날씨</label>
            <select id="weather" class="w-full border rounded-xl px-3 py-2">
              <option value="sunny">맑음</option>
              <option value="cloudy">흐림</option>
              <option value="rainy">비</option>
            </select>
          </div>
          <div>
            <label class="block text-sm mb-1">실내/실외</label>
            <select id="inout" class="w-full border rounded-xl px-3 py-2">
              <option value="any">상관없음</option>
              <option value="indoor">실내</option>
              <option value="outdoor">실외</option>
            </select>
          </div>
        </div>

        <label class="text-sm flex items-center gap-2 mt-3">
          <input id="strictBudget" type="checkbox" class="scale-110"> 예산 엄수
        </label>

        <div class="flex gap-2 mt-4">
          <button id="btnLoad" class="btn btn-outline">구 데이터 불러오기</button>
          <button id="btnGenerate" class="btn btn-primary flex-1">코스 자동 생성</button>
        </div>
        <div id="status" class="text-xs text-gray-500 mt-2">구 선택 후 [구 데이터 불러오기] → [코스 자동 생성]</div>
      </div>

      <div class="card">
        <div class="badge mb-2">총액 요약</div>
        <div id="summary" class="space-y-1 text-sm text-gray-700">
          <div>액티비티: -</div>
          <div>숙박: -</div>
          <div class="font-semibold">합계: -</div>
        </div>
      </div>
    </section>

    <!-- 우측: 지도 + 제안 카드 -->
    <section class="md:col-span-2 space-y-4">
      <div class="card">
        <div class="flex items-center justify-between">
          <div class="font-bold">지도</div>
          <div class="flex gap-2 text-xs">
            <span class="pill route-color-1">제안 1</span>
            <span class="pill route-color-2">제안 2</span>
            <span class="pill route-color-3">제안 3</span>
          </div>
        </div>
        <div id="map" class="w-full h-[420px] rounded-xl mt-2"></div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4" id="proposals"></div>
    </section>
  </main>

  <script>
    // ===== 상수/상태 =====
    const TOURAPI_PROXY = "/api/tourapi";
    const SEOUL_AREACODE = 1;
    const TARGET_UTIL = 0.95; // 예산 사용 목표치(95% 전후)

    let PLACES = []; // 12+14+28
    let HOTELS = []; // 32

    // 지도
    let map, layers = { markers: null, route1:null, route2:null, route3:null };
    (function initMap(){
      map = L.map('map').setView([37.5665,126.9780], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19, attribution:'© OpenStreetMap'}).addTo(map);
      layers.markers = L.layerGroup().addTo(map);
    })();

    // ===== TourAPI: 구코드 기반 로딩 =====
    async function fetchArea(areaCode, sigunguCode, contentTypeId, numOfRows=120){
      const u = new URL(TOURAPI_PROXY, location.origin);
      u.searchParams.set("by","area");
      u.searchParams.set("areaCode", String(areaCode));
      u.searchParams.set("sigunguCode", String(sigunguCode));
      u.searchParams.set("contentTypeId", String(contentTypeId));
      u.searchParams.set("numOfRows", String(numOfRows));
      const r = await fetch(u.toString());
      const data = await r.json();
      return data?.response?.body?.items?.item || [];
    }

    function deriveThemesFromTitle(t=''){
      const tags = [];
      if (/공원|숲|산책|천|호수|섬|오름|둘레길|성곽길|한강/.test(t)) tags.push('산책','힐링');
      if (/타워|전망|스카이|뷰|포토|야경/.test(t)) tags.push('뷰','설렘');
      if (/박물관|미술관|역사|궁|성|전시|기념관|도서관/.test(t)) tags.push('역사','사색');
      if (!tags.length) tags.push('트렌드');
      return Array.from(new Set(tags));
    }

    // 타입/비용 추정(럭셔리/프리미엄 강화)
    function guessType(title="", ctid=""){
      const t=title||"";
      if (ctid==="14") return 'indoor';
      if (/박물관|미술관|전시|기념관|도서관|갤러리|아쿠아리움|키즈|VR|AR|쇼핑몰|몰|백화점|전망대/.test(t)) return 'indoor';
      if (/공원|산|둘레길|성곽길|강|천|호수|시장|거리|광장|한강|야외|야경포인트/.test(t)) return 'outdoor';
      return 'outdoor';
    }
    function estimatePlaceCost(title="", type="outdoor", ctid=""){
      const t = title||"";
      if (ctid==="14" || /박물관|미술관|전시|기념관|아쿠아리움|플랜터리움|과학관/.test(t)) return 8000 + Math.floor(Math.random()*12000);
      if (ctid==="28" || /체험|테마|VR|AR|카트|서핑|케이블카|전망대|스카이|플라잉|튜브|보트|요트|메타버스/.test(t)) return 15000 + Math.floor(Math.random()*35000);
      if (/타워|전망|N타워|서울타워|스카이|라운지/.test(t)) return 18000 + Math.floor(Math.random()*25000);
      if (/공원|숲|산책|천|강|호수|해변|오름|시장|거리|둘레길|성곽길|한강/.test(t)) return Math.random()<0.5?0:2000+Math.floor(Math.random()*4000);
      if (/궁|고궁|왕릉|사찰|한옥|문화재/.test(t)) return 0 + Math.floor(Math.random()*6000);
      if (/백화점|아울렛|몰|더현대|플래그십|쇼핑|마켓/.test(t)) return 0;
      return type==='indoor' ? 8000 + Math.floor(Math.random()*20000) : (Math.random()<0.6?0:3000+Math.floor(Math.random()*8000));
    }
    function estimateHotelNight(title=""){
      const t = title||"";
      // 럭셔리 키워드면 30~60만+ 범위
      if (/포시즌스|콘래드|하얏트|그랜드|페어몬트|래디슨|JW|리츠|신라호텔|롯데호텔|조선팰리스|웨스틴|힐튼/.test(t))
        return 300000 + Math.floor(Math.random()*350000); // 30만~65만
      if (/리조트|스파|프리미어|프라임|프리미엄|스위트|콘도/.test(t))
        return 180000 + Math.floor(Math.random()*180000);
      if (/호텔|관광호텔|시티|스테이호텔/.test(t))
        return 90000 + Math.floor(Math.random()*90000);
      if (/한옥|스테이|펜션|게스트|민박|호스텔/.test(t))
        return 50000 + Math.floor(Math.random()*70000);
      return 100000 + Math.floor(Math.random()*100000);
    }

    function mapItemsToPlaces(items){
      return (items||[]).map((it,idx)=>{
        const typeGuess = guessType(it.title||"", String(it.contenttypeid||""));
        return {
          id: idx+1,
          name: it.title,
          lat: Number(it.mapy), lng: Number(it.mapx),
          type: typeGuess,
          cost: estimatePlaceCost(it.title||"", typeGuess, String(it.contenttypeid||"")),
          themes: deriveThemesFromTitle(it.title||""),
          fomo: 70 + (idx%25)
        };
      }).filter(p=>isFinite(p.lat)&&isFinite(p.lng));
    }
    function mapItemsToHotels(items){
      return (items||[]).map((it,idx)=>({
        id: 1000+idx+1,
        name: it.title, type:"hotel",
        lat: Number(it.mapy), lng: Number(it.mapx),
        nightCost: estimateHotelNight(it.title||""),
        star: 4.0 + (idx%10)/10,
        fomo: 70 + (idx%25)
      })).filter(h=>isFinite(h.lat)&&isFinite(h.lng));
    }

    // 점수/거리 유틸
    function scorePlace(p, weather){
      const fomo = p.fomo/10;
      const weatherBoost = (weather==='rainy' && p.type==='indoor') ? 6 : (weather==='sunny' && p.type==='outdoor') ? 4 : 0;
      const priceSoft = (p.cost||0) > 0 ? - ((p.cost||0) >= 30000 ? 2 : 0) : 1;
      return fomo + weatherBoost + priceSoft + 6;
    }
    function scoreHotel(h){ return (h.fomo/10) + (h.star||4); }

    function haversine(a,b){
      const R=6371; const toRad=d=>d*Math.PI/180;
      const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
      const s1=Math.sin(dLat/2), s2=Math.sin(dLng/2);
      const c=2*Math.asin(Math.sqrt(s1*s1+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2));
      return R*c;
    }
    function nearestNeighborOrder(points, start){
      if(points.length<=1) return points.slice();
      const used=new Set(); let route=[]; let cur={...start};
      for(let i=0;i<points.length;i++){
        let best=null, bestD=1e9, idx=-1;
        for(let j=0;j<points.length;j++){
          if(used.has(j)) continue;
          const d=haversine(cur, points[j]);
          if(d<bestD){ bestD=d; best=points[j]; idx=j; }
        }
        used.add(idx); route.push(best); cur=best;
      }
      return route;
    }

    // 메타
    function buildTripMeta(mode){
      const nights = mode==="1n2d"?1 : mode==="2n3d"?2 : 0;
      const days = nights>0 ? nights+1 : 1;
      const perDay = nights===0 ? 3 : 4;
      const maxPlaces = days * perDay;
      return { nights, days, perDay, maxPlaces };
    }

    // 액티비티 선택(예산 비례 상향)
    function selectActivities(pool, actBudget, maxPlaces, strict, bias, inout){
      const tagBoost = p=>{
        if(bias==='view' && p.themes.includes('뷰')) return 4;
        if(bias==='history' && (p.themes.includes('역사')||p.themes.includes('사색'))) return 4;
        if(bias==='walk' && p.themes.includes('산책')) return 4;
        if(bias==='trend' && p.themes.includes('트렌드')) return 4;
        return 0;
      };

      const base = pool.map(p=>({...p, score2: scorePlace(p, weatherSel.value) + tagBoost(p)}))
                       .sort((a,b)=> b.score2 - a.score2)
                       .slice(0,100);

      // in/out
      let step = inout==='any' ? base : base.filter(p=>p.type===inout);
      if(step.length < maxPlaces*1.5) step = base;

      // per-item 상한: 예산이 클수록 넉넉히
      const perItemCeil = maxPlaces>0
        ? Math.max(10000, Math.floor((actBudget*0.85)/maxPlaces * 1.6))
        : Infinity;
      let candidates = step.filter(p => (p.cost||0) <= perItemCeil);
      if(candidates.length===0) candidates = step;

      const freeFirst = candidates.filter(p => (p.cost||0)===0).slice(0, Math.min(2, maxPlaces));
      let remain = Math.floor(actBudget*0.9) - freeFirst.reduce((s,p)=>s+(p.cost||0),0);
      let slots = maxPlaces - freeFirst.length;

      const rest = candidates
        .filter(p=>!freeFirst.find(f=>f.id===p.id))
        .sort((a,b)=>{
          const ra = (a.cost||0)>0 ? (a.score2/a.cost) : a.score2*10;
          const rb = (b.cost||0)>0 ? (b.score2/b.cost) : b.score2*10;
          return rb-ra;
        });

      const chosen=[...freeFirst];
      for(const p of rest){
        if(slots<=0) break;
        const c=p.cost||0;
        if(c<=remain){ chosen.push(p); remain-=c; slots--; }
        else if(!strict && c<=actBudget*0.5 && chosen.length<2){ chosen.push(p); slots--; }
      }

      // 남으면 비싼 순으로 추가 교체(업스케일)
      if(!strict && chosen.length){
        const spare = rest.filter(p=>!chosen.find(x=>x.id===p.id)).sort((a,b)=>(b.cost||0)-(a.cost||0));
        for(const cand of spare){
          if(remain<=0) break;
          const cheapestIdx = chosen.reduce((idx,cur,i,arr)=> (arr[idx].cost||0) < (cur.cost||0) ? idx : i, 0);
          if((cand.cost||0) > (chosen[cheapestIdx].cost||0) && (cand.cost||0) - (chosen[cheapestIdx].cost||0) <= remain){
            remain -= (cand.cost||0) - (chosen[cheapestIdx].cost||0);
            chosen[cheapestIdx] = cand;
          }
        }
      }
      return chosen.slice(0, maxPlaces);
    }

    // 호텔: “고가 우선 + 예산 맞추기”
    function selectHotels(pool, nights, hotelBudget, strict){
      if(nights<=0) return [];
      const perNightTarget = Math.max(80000, Math.floor(hotelBudget/nights));
      // 예산 한도 내에서 비싼 순
      let candidates = pool
        .filter(h => (h.nightCost||0) <= perNightTarget*1.25)
        .sort((a,b)=> (b.nightCost||0)-(a.nightCost||0));
      if(candidates.length===0) candidates = pool.slice().sort((a,b)=> (a.nightCost||0)-(b.nightCost||0));

      const chosen=[];
      let remain = hotelBudget;
      for(const h of candidates){
        if(chosen.length>=nights) break;
        if(!strict || (h.nightCost||0) <= remain){ chosen.push(h); remain -= (h.nightCost||0); }
      }
      // 부족 시 더 저렴한 것으로 채움
      while(chosen.length<nights){
        const cheap = pool.slice().sort((a,b)=>(a.nightCost||0)-(b.nightCost||0));
        chosen.push(cheap[chosen.length] || cheap[0]);
      }
      return chosen.slice(0,nights);
    }

    // 스케줄
    function buildTimeline(orderedPlaces, hotels, mode, center){
      const {nights, days} = buildTripMeta(mode);
      const start = 10*60, perSlot = (mode==="6h"? 90: 100), lunch=13*60;
      const perDay = Math.ceil(orderedPlaces.length/days);
      const blocks=[]; let idx=0;

      for(let d=0; d<days; d++){
        let t=start; blocks.push({ type:'day', label:`Day ${d+1}` });
        for(let k=0; k<perDay; k++){
          const p = orderedPlaces[idx++]; if(!p) break;
          if(t < lunch && t+perSlot >= lunch){ blocks.push({ type:'meal', time: toHHMM(lunch), label:'점심' }); t=lunch+60; }
          blocks.push({ type:'place', time: toHHMM(t), name:p.name, cost:p.cost, lat:p.lat, lng:p.lng });
          t += perSlot;
        }
        if(d < nights && hotels[d]){
          const h = hotels[d];
          blocks.push({ type:'hotel', time:'체크인(18:00~)', name:h.name, cost:h.nightCost, lat:h.lat, lng:h.lng });
        }
      }
      return blocks;
    }
    function toHHMM(m){ const h=Math.floor(m/60), mm=String(m%60).padStart(2,'0'); return `${h}:${mm}` }

    // 남은 예산 채우기: 호텔 업그레이드 → 액티비티 업그레이드 → 프리미엄 추가옵션 삽입
    function rebalanceToBudget(proposal, budget, center){
      const targetLow = Math.floor(budget*0.92), targetHigh = Math.floor(budget*0.98);
      let cur = proposal.money.total;

      // 1) 호텔 업그레이드(더 비싼 후보로 교체)
      if(cur < targetLow && proposal.hotels.length){
        const allHotels = HOTELS.slice().sort((a,b)=>(b.nightCost||0)-(a.nightCost||0));
        for(let i=0;i<proposal.hotels.length;i++){
          const h = proposal.hotels[i];
          const better = allHotels.find(x => (x.nightCost||0) > (h.nightCost||0) && (cur + (x.nightCost-h.nightCost)) <= targetHigh);
          if(better){ cur += (better.nightCost - h.nightCost); proposal.hotels[i] = better; }
          if(cur >= targetLow) break;
        }
      }

      // 2) 액티비티 업그레이드(더 비싼 유료로 대체)
      if(cur < targetLow && proposal.places.length){
        const paidDesc = PLACES.filter(p=>(p.cost||0)>0).sort((a,b)=>(b.cost||0)-(a.cost||0));
        for(let i=0;i<proposal.places.length;i++){
          const p = proposal.places[i];
          const better = paidDesc.find(x => (x.cost||0) > (p.cost||0) && (cur + (x.cost-p.cost)) <= targetHigh);
          if(better){ cur += (better.cost - p.cost); proposal.places[i] = better; }
          if(cur >= targetLow) break;
        }
      }

      // 3) 프리미엄 추가 옵션 삽입(위치: 중심부)
      const extras = [
        {name:"🍽️ 프리미엄 디너 코스", cost:120000},
        {name:"💆 스파·사우나 2시간", cost:90000},
        {name:"🎭 공연 VIP 좌석", cost:150000},
        {name:"🌃 전망대 패스트트랙", cost:70000},
        {name:"🛥️ 한강 보트/요트 체험", cost:130000},
      ];
      let ei=0;
      while(cur < targetLow && ei<extras.length){
        const add = extras[ei++];
        if(cur + add.cost <= targetHigh){
          proposal.blocks.push({ type:'extra', time:'저녁', name:add.name, cost:add.cost, lat:center.lat, lng:center.lng });
          cur += add.cost;
        }else{
          // 부분 충전용 작은 옵션
          const small = {name:"☕ 카페 디저트 세트", cost:30000};
          if(cur + small.cost <= targetHigh){
            proposal.blocks.push({ type:'extra', time:'휴식', name:small.name, cost:small.cost, lat:center.lat, lng:center.lng });
            cur += small.cost;
          }else break;
        }
      }

      // 합계 갱신
      const actTotal = proposal.places.reduce((s,p)=>s+(p.cost||0),0) + proposal.blocks.filter(b=>b.type==='extra').reduce((s,b)=>s+(b.cost||0),0);
      const hotelTotal = proposal.hotels.reduce((s,h)=>s+(h.nightCost||0),0);
      proposal.money = { actTotal, hotelTotal, total: actTotal + hotelTotal };
      return proposal;
    }

    // 제안 생성
    function generateProposals({center, mode, budget, weather, inout, strict}){
      const { maxPlaces, nights } = buildTripMeta(mode);
      const hotelBudget = nights>0 ? Math.floor(budget*0.6) : 0;
      const actBudget = budget - hotelBudget;

      const placePool = PLACES.map(p=>({...p, score: scorePlace(p, weather)}));
      const hotelPool = HOTELS.map(h=>({...h, score: scoreHotel(h)}));

      const biases = nights>0 ? ['trend','view','history'] : ['walk','trend','view'];
      const proposals = [];
      for(let i=0;i<3;i++){
        const bias = biases[i];
        const acts = selectActivities(placePool, actBudget, maxPlaces, strict, bias, inout);
        const ordered = nearestNeighborOrder(acts, center);
        const hotels = selectHotels(hotelPool, nights, hotelBudget, strict);
        const blocks = buildTimeline(ordered, hotels, mode, center);

        const actTotal = ordered.reduce((s,p)=>s+(p.cost||0),0);
        const hotelTotal = hotels.reduce((s,h)=>s+(h.nightCost||0),0);
        const base = {
          id:i+1, bias, blocks:[...blocks],
          places:[...ordered], hotels:[...hotels],
          money:{ actTotal, hotelTotal, total: actTotal+hotelTotal }
        };
        // 목표 사용률로 리밸런싱
        const tuned = rebalanceToBudget(base, budget, center);
        proposals.push(tuned);
      }
      return proposals;
    }

    // 지도 렌더링
    function clearRoutes(){
      ['route1','route2','route3'].forEach(k=>{ if(layers[k]){ map.removeLayer(layers[k]); layers[k]=null; }});
      layers.markers.clearLayers();
    }
    function drawProposalOnMap(prop){
      clearRoutes();
      const latlngs=[];
      prop.blocks.forEach(b=>{
        if(b.type==='place' || b.type==='hotel' || b.type==='extra'){
          latlngs.push([b.lat,b.lng]);
          const label = (b.type==='hotel'?'🏨 ':b.type==='extra'?'⭐ ':'')+b.name;
          layers.markers.addLayer(L.marker([b.lat,b.lng]).bindPopup(label));
        }
      });
      if(latlngs.length>=2){
        layers['route'+prop.id] = L.polyline(latlngs, {
          weight:5, opacity:.9,
          color: prop.id===1 ? '#0ea5e9' : prop.id===2 ? '#22c55e' : '#f59e0b'
        }).addTo(map);
        map.fitBounds(layers['route'+prop.id].getBounds(), {padding:[20,20]});
      }else if(latlngs[0]){ map.setView(latlngs[0], 13); }
    }

    function renderProposals(props){
      const box = document.getElementById('proposals');
      box.innerHTML = '';
      props.forEach(p=>{
        const wrap = document.createElement('div');
        wrap.className = 'card';
        const title = p.id===1?'제안 1':p.id===2?'제안 2':'제안 3';
        const colorClass = p.id===1?'route-color-1':p.id===2?'route-color-2':'route-color-3';

        const list = p.blocks.map(b=>{
          if(b.type==='day') return `<li class="mt-2 font-semibold">${b.label}</li>`;
          if(b.type==='meal') return `<li class="ml-4 text-gray-600">${b.time} • ${b.label}</li>`;
          if(b.type==='place') return `<li class="ml-4">${b.time} • ${b.name} (~${(b.cost||0).toLocaleString()}원)</li>`;
          if(b.type==='hotel') return `<li class="ml-4">🏨 ${b.time} • ${b.name} (1박 ~${(b.cost||0).toLocaleString()}원)</li>`;
          if(b.type==='extra') return `<li class="ml-4">⭐ ${b.time} • ${b.name} (~${(b.cost||0).toLocaleString()}원)</li>`;
          return '';
        }).join('');

        wrap.innerHTML = `
          <div class="flex items-center justify-between mb-1">
            <div class="font-bold ${colorClass}">${title}</div>
            <span class="badge">${p.bias}</span>
          </div>
          <div class="text-sm text-gray-600 mb-2">총액 ~${p.money.total.toLocaleString()}원 (액티비티 ${p.money.actTotal.toLocaleString()} + 숙박 ${p.money.hotelTotal.toLocaleString()})</div>
          <ol class="text-sm text-gray-700">${list}</ol>
          <div class="mt-3 flex gap-2">
            <button class="btn btn-outline" data-prop="${p.id}" data-action="show">지도에 보기</button>
            <button class="btn btn-primary" data-prop="${p.id}" data-action="adopt">이 코스 채택</button>
          </div>
        `;
        box.appendChild(wrap);
      });

      // 버튼 이벤트
      box.querySelectorAll('button[data-action="show"]').forEach(btn=>{
        btn.onclick = ()=> {
          const id = Number(btn.dataset.prop);
          const prop = currentProposals.find(x=>x.id===id);
          if(prop) drawProposalOnMap(prop);
          updateSummary(prop.money.actTotal, prop.money.hotelTotal);
        };
      });
      box.querySelectorAll('button[data-action="adopt"]').forEach(btn=>{
        btn.onclick = ()=> {
          const id = Number(btn.dataset.prop);
          const prop = currentProposals.find(x=>x.id===id);
          if(prop){
            drawProposalOnMap(prop);
            updateSummary(prop.money.actTotal, prop.money.hotelTotal);
            alert(`${id}번 코스를 채택했습니다!`);
          }
        };
      });
    }

    function updateSummary(act, hotel){
      const el = document.getElementById('summary');
      el.innerHTML = `
        <div>액티비티: ~${(act||0).toLocaleString()}원</div>
        <div>숙박: ~${(hotel||0).toLocaleString()}원</div>
        <div class="font-semibold">합계: ~${((act||0)+(hotel||0)).toLocaleString()}원</div>
      `;
    }

    // ===== 이벤트 =====
    let currentCenter = { lat:37.5665, lng:126.9780 };
    let currentProposals = [];

    document.getElementById('btnLoad').onclick = async ()=>{
      const opt = document.getElementById('district').selectedOptions[0];
      const sigungu = Number(opt.value);
      const [lat,lng] = opt.dataset.center.split(',').map(Number);
      currentCenter = { lat, lng };
      document.getElementById('status').textContent = '해당 구의 장소/숙소 로딩 중…';

      try{
        const [raw12, raw14, raw28, raw32] = await Promise.all([
          fetchArea(SEOUL_AREACODE, sigungu, 12, 220),  // 관광지
          fetchArea(SEOUL_AREACODE, sigungu, 14, 160),  // 문화시설
          fetchArea(SEOUL_AREACODE, sigungu, 28, 160),  // 레포츠/체험
          fetchArea(SEOUL_AREACODE, sigungu, 32, 220),  // 숙박
        ]);
        PLACES = [
          ...mapItemsToPlaces(raw12),
          ...mapItemsToPlaces(raw14),
          ...mapItemsToPlaces(raw28),
        ];
        HOTELS = mapItemsToHotels(raw32);

        // 중복 제거
        const seen = new Set();
        PLACES = PLACES.filter(p=>{
          const k = `${p.name}|${p.lat.toFixed(4)}|${p.lng.toFixed(4)}`;
          if(seen.has(k)) return false; seen.add(k); return true;
        });

        document.getElementById('status').textContent = `로드 완료: 장소 ${PLACES.length} · 숙소 ${HOTELS.length}`;
        map.setView([lat,lng], 13);
        layers.markers.clearLayers();
      }catch(e){
        console.error(e);
        document.getElementById('status').textContent = '로드 실패(키/쿼터/파라미터 확인)';
      }
    };

    document.getElementById('btnGenerate').onclick = ()=>{
      if(PLACES.length===0){ alert('먼저 [구 데이터 불러오기]를 눌러주세요.'); return; }
      const mode   = document.getElementById('tripMode').value;
      const budget = Number(document.getElementById('budget').value||0);
      const weather= document.getElementById('weather').value;
      const inout  = document.getElementById('inout').value;
      const strict = !!document.getElementById('strictBudget').checked;

      window.weatherSel = { value: weather }; // 내부 함수에서 참조

      currentProposals = generateProposals({
        center: currentCenter, mode, budget, weather, inout, strict
      });
      renderProposals(currentProposals);

      drawProposalOnMap(currentProposals[0]);
      updateSummary(currentProposals[0].money.actTotal, currentProposals[0].money.hotelTotal);

      const t = currentProposals[0].money.total.toLocaleString();
      document.getElementById('status').textContent = `코스 자동 생성 완료 · 제안 3종 · 1안 총액 ~${t}원 (목표 ${Math.round(TARGET_UTIL*100)}%)`;
    };
  </script>
</body>
</html>