<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TrendTrip | ê°ì •Â·íŠ¸ë Œë“œÂ·ì˜ˆì‚°Â·ìˆ™ë°• í¬í•¨ ì¶”ì²œ</title>
  <meta name="description" content="ê°ì •Â·íŠ¸ë Œë“œÂ·ì˜ˆì‚°Â·ë‚ ì”¨Â·ìˆ™ë°•ì„ ë°˜ì˜í•´ ë§ì¶¤ ì—¬í–‰ ì½”ìŠ¤ì™€ ìˆ™ì†Œë¥¼ ì¶”ì²œí•©ë‹ˆë‹¤." />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2280%22>ğŸ§­</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root{ --brand:#0ea5e9 }
    html,body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif}
    .chip{padding:.4rem .9rem;border:1px solid #e5e7eb;border-radius:9999px;cursor:pointer;transition:.15s}
    .chip:hover{background:#f8fafc}
    .chip--active{background:#e0f2fe;border-color:#7dd3fc}
    .card{border-radius:1.25rem;box-shadow:0 8px 30px rgba(2,132,199,.08);padding:1.1rem;background:#fff}
    .btn{padding:.65rem 1rem;border-radius:.9rem;font-weight:700;transition:.12s;display:inline-flex;align-items:center;gap:.5rem}
    .btn:hover{transform:translateY(-1px)}
    .btn-primary{background:var(--brand);color:#fff}
    .btn-outline{background:#fff;border:1px solid #e5e7eb}
    .badge{padding:.25rem .55rem;border-radius:.5rem;background:#f1f5f9;font-size:.7rem}
    .glass{background:linear-gradient(180deg,rgba(255,255,255,.75),rgba(255,255,255,.6));backdrop-filter:saturate(160%) blur(8px);border:1px solid rgba(255,255,255,.3);border-radius:1.25rem}
    .section{scroll-margin-top:80px}
  </style>
</head>
<body class="bg-gradient-to-b from-sky-50 via-white to-white text-gray-800">

  <!-- Header -->
  <header class="sticky top-0 z-40">
    <div class="glass max-w-7xl mx-auto my-3 px-4 py-3 flex items-center justify-between">
      <a class="flex items-center gap-2 font-extrabold text-lg" href="#"><span class="text-2xl">ğŸ§­</span> TrendTrip</a>
      <nav class="hidden sm:flex gap-2 text-sm">
        <a class="chip" href="#features">ê¸°ëŠ¥</a>
        <a class="chip" href="#discover">ì¶”ì²œ</a>
        <a class="chip" href="#plan">ë‚´ í”Œëœ</a>
      </nav>
    </div>
  </header>

  <!-- Hero -->
  <section class="section" id="home">
    <div class="max-w-7xl mx-auto px-4 pt-8 pb-12 grid md:grid-cols-2 gap-8 items-center">
      <div>
        <span class="badge">ê°ì •Â·ë‚ ì”¨Â·ì˜ˆì‚°Â·ìˆ™ë°• í¬í•¨</span>
        <h1 class="text-4xl md:text-5xl font-extrabold leading-tight mt-3">
          ì˜¤ëŠ˜ ê¸°ë¶„ì— ë§ì¶°<br><span class="text-sky-600">ì½”ìŠ¤ + ìˆ™ì†Œê¹Œì§€ í•œë²ˆì—</span>
        </h1>
        <p class="text-gray-600 mt-4">6ì‹œê°„ ë‹¹ì¼ Â· 1ë°•2ì¼ Â· 2ë°•3ì¼ ì¤‘ ì„ íƒí•˜ê³ , ì˜ˆì‚° ì•ˆì—ì„œ ì•¡í‹°ë¹„í‹°ì™€ ìˆ™ë°•ì„ ìë™ ë°°ë¶„í•´ ì¶”ì²œí•´ìš”.</p>
        <div class="mt-6 flex flex-wrap gap-3">
          <button id="btnQuick" class="btn btn-primary">ë¹ ë¥´ê²Œ ì²´í—˜í•˜ê¸°</button>
          <a class="btn btn-outline" href="#discover">ì¶”ì²œë¶€í„° ë³´ê¸°</a>
        </div>
        <p class="mt-3 text-xs text-gray-500">* ê³µê°œ ë²„ì „ â€” ì‹¤ì œ TourAPI ê¸°ë°˜</p>
      </div>
      <div class="card grid grid-cols-2 gap-3">
        <div class="card"><div class="text-xs text-gray-500">ì…ë ¥</div><div class="font-semibold">ê°ì •Â·ë‚ ì”¨Â·ì˜ˆì‚°Â·ì—¬í–‰ìœ í˜•</div></div>
        <div class="card"><div class="text-xs text-gray-500">ë¶„ì„</div><div class="font-semibold">ê°ì •â†’í…Œë§ˆ ë§¤í•‘</div></div>
        <div class="card"><div class="text-xs text-gray-500">ì¶”ì²œ</div><div class="font-semibold">ì•¡í‹°ë¹„í‹° + ìˆ™ì†Œ</div></div>
        <div class="card"><div class="text-xs text-gray-500">ê²°ê³¼</div><div class="font-semibold">ë£¨íŠ¸ & ì´ì•¡</div></div>
      </div>
    </div>
  </section>

  <!-- Controls -->
  <section class="section" id="features">
    <div class="max-w-7xl mx-auto px-4 pb-6 grid md:grid-cols-4 gap-6">

      <!-- ê°ì • -->
      <div class="card">
        <h3 class="font-bold mb-3">1) ê°ì • ì…ë ¥</h3>
        <div id="emotionChips" class="flex flex-wrap gap-2"></div>
        <input id="customEmotion" class="mt-3 w-full border rounded-xl px-3 py-2" placeholder="ì§ì ‘ ì…ë ¥ (ì˜ˆ: ì„¤ë ˜, ë¬´ê¸°ë ¥)" />
      </div>

      <!-- ë‚ ì”¨/ì‹¤ë‚´ì™¸ -->
      <div class="card">
        <h3 class="font-bold mb-3">2) ë‚ ì”¨ & ì‹¤ë‚´/ì‹¤ì™¸</h3>
        <div class="flex items-center gap-2 mb-2">
          <label class="text-sm w-16">ë‚ ì”¨</label>
          <select id="weather" class="border rounded-xl px-3 py-2 flex-1">
            <option value="sunny">ë§‘ìŒ</option>
            <option value="cloudy">íë¦¼</option>
            <option value="rainy">ë¹„</option>
          </select>
        </div>
        <div class="flex items-center gap-2">
          <label class="text-sm w-16">ì„ í˜¸</label>
          <select id="inout" class="border rounded-xl px-3 py-2 flex-1">
            <option value="any">ìƒê´€ì—†ìŒ</option>
            <option value="indoor">ì‹¤ë‚´</option>
            <option value="outdoor">ì‹¤ì™¸</option>
          </select>
        </div>
      </div>

      <!-- ì˜ˆì‚°/ì—¬í–‰ìœ í˜• -->
      <div class="card">
        <h3 class="font-bold mb-3">3) ì˜ˆì‚° & ì—¬í–‰ìœ í˜•</h3>
        <div class="flex items-center gap-2 mb-2">
          <label class="text-sm w-20">ì´ì˜ˆì‚°(â‚©)</label>
          <input id="budget" type="number" class="border rounded-xl px-3 py-2 w-44" value="120000" />
        </div>
        <div class="flex items-center gap-2">
          <label class="text-sm w-20">ì—¬í–‰</label>
          <select id="tripMode" class="border rounded-xl px-3 py-2 w-44">
            <option value="6h">6ì‹œê°„ ë‹¹ì¼</option>
            <option value="1n2d">1ë°• 2ì¼</option>
            <option value="2n3d">2ë°• 3ì¼</option>
          </select>
        </div>
        <div class="text-xs text-gray-500 mt-2">* ìˆ™ë°• í¬í•¨ ì‹œ ì´ì˜ˆì‚°ì„ ìˆ™ë°•(ê¸°ë³¸ 60%)Â·ì•¡í‹°ë¹„í‹°(40%)ë¡œ ìë™ ë°°ë¶„</div>
      </div>

      <!-- ì§€ì—­/ë²„íŠ¼ -->
      <div class="card">
        <h3 class="font-bold mb-3">4) ì§€ì—­/ì‹¤í–‰</h3>
        <div class="flex items-center gap-2">
          <label class="text-sm w-16">ì§€ì—­</label>
          <select id="sido" class="border rounded-xl px-3 py-2 flex-1">
            <option value="1"  data-center="37.5665,126.9780">ì„œìš¸</option>
            <option value="6"  data-center="35.1796,129.0756">ë¶€ì‚°</option>
            <option value="39" data-center="33.4996,126.5312">ì œì£¼</option>
          </select>
        </div>
        <div class="flex items-center gap-2 mt-2">
          <label class="text-sm w-16">ì˜µì…˜</label>
          <label class="text-sm flex items-center gap-1"><input id="strictBudget" type="checkbox" class="scale-110"> ì˜ˆì‚° ì—„ìˆ˜</label>
        </div>
        <div class="mt-3 flex flex-wrap gap-2">
          <button id="btnAreaLoad" class="btn btn-outline">ì§€ì—­ ë¶ˆëŸ¬ì˜¤ê¸°</button>
          <button id="btnRecommend" class="btn btn-primary">ì¶”ì²œ ë³´ê¸°</button>
          <button id="btnRoute" class="btn btn-outline">ë£¨íŠ¸ ìƒì„±</button>
        </div>
        <div id="status" class="text-sm text-gray-500 mt-2"></div>
      </div>
    </div>
  </section>

  <!-- Discover -->
  <section class="section" id="discover">
    <div class="max-w-7xl mx-auto px-4 grid lg:grid-cols-2 gap-6">
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-bold">ì¶”ì²œ ì¥ì†Œ(ì•¡í‹°ë¹„í‹°)</h3>
          <span class="badge">FOMO + ì˜ˆì‚°</span>
        </div>
        <ul id="listPlaces" class="space-y-3"></ul>
      </div>
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-bold">ì¶”ì²œ ìˆ™ì†Œ</h3>
          <span class="badge">ì˜ˆì‚°/ë°•ìˆ˜ ë°˜ì˜</span>
        </div>
        <ul id="listHotels" class="space-y-3"></ul>
      </div>
      <div class="card lg:col-span-2">
        <h3 class="font-bold mb-3">ì§€ë„</h3>
        <div id="map" class="w-full h-[440px] rounded-xl"></div>
      </div>
    </div>
  </section>

  <!-- Plan -->
  <section class="section" id="plan">
    <div class="max-w-7xl mx-auto px-4 my-6 card">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-bold">ë‚´ í”Œëœ</h3>
        <div class="flex gap-2">
          <button id="btnSave" class="btn btn-primary">ì €ì¥</button>
          <button id="btnLoad" class="btn btn-outline">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>
      </div>
      <ol id="route" class="list-decimal list-inside text-sm text-gray-700"></ol>
      <div id="planCost" class="mt-2 text-sm text-gray-600"></div>
    </div>
  </section>

  <footer class="mt-10 border-t">
    <div class="max-w-7xl mx-auto px-4 py-8 text-sm text-gray-500 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div>Â© <span id="yy"></span> TrendTrip.</div>
      <div class="flex items-center gap-3">
        <span class="badge">ê³µê°œë²„ì „ Â· ìƒ˜í”Œë°ì´í„°</span>
        <a class="text-sky-600 hover:underline" href="#home">ë§¨ ìœ„ë¡œ</a>
      </div>
    </div>
  </footer>

  <script>
    // ===== ê³µí†µ =====
    document.getElementById('yy').textContent = new Date().getFullYear();
    const TOURAPI_PROXY = "/api/tourapi"; // ê°™ì€ ë„ë©”ì¸ ê¸°ì¤€
    const CENTER = { lat: 37.5665, lng: 126.9780 };

    // ìƒ˜í”Œ(ë°±ì—…)
    const MOCK_PLACES = [
      { id:1, name:"ê²½ë³µê¶", lat:37.5796, lng:126.9770, type:"outdoor", cost:3000, themes:["ì—­ì‚¬","íë§"], fomo:88 },
      { id:2, name:"ë¶ì´Œí•œì˜¥ë§ˆì„", lat:37.5826, lng:126.9830, type:"outdoor", cost:0, themes:["ê°ì„±","ì‚°ì±…"], fomo:91 },
      { id:3, name:"ìµì„ ë™ ì¹´í˜", lat:37.5724, lng:126.9917, type:"indoor", cost:9000, themes:["ìœ„ë¡œ","ê°ì„±"], fomo:84 },
      { id:4, name:"êµ­ë¦½í˜„ëŒ€ë¯¸ìˆ ê´€ ì„œìš¸", lat:37.5790, lng:126.9803, type:"indoor", cost:6000, themes:["ì‚¬ìƒ‰","íë§"], fomo:76 },
      { id:5, name:"ì²­ê³„ì²œ ì‚°ì±…", lat:37.5690, lng:126.9780, type:"outdoor", cost:0, themes:["ì •í™”","ì‚°ì±…"], fomo:73 },
      { id:6, name:"ë¡¯ë°ì›”ë“œíƒ€ì›Œ ì „ë§ëŒ€", lat:37.5131, lng:127.1029, type:"indoor", cost:27000, themes:["ì„¤ë ˜","ë·°"], fomo:95 },
    ];
    const MOCK_HOTELS = [
      { id:101, name:"OO í˜¸í…”", lat:37.566, lng:126.982, type:"hotel", nightCost:90000, star:4.2, themes:["í¸ì•ˆ","ì ‘ê·¼ì„±"], fomo:80 },
      { id:102, name:"í•œì˜¥ ìŠ¤í…Œì´", lat:37.581, lng:126.983, type:"hotel", nightCost:70000, star:4.5, themes:["ê°ì„±","ë¡œì»¬"], fomo:78 },
      { id:103, name:"ê²ŒìŠ¤íŠ¸í•˜ìš°ìŠ¤", lat:37.555, lng:126.925, type:"hotel", nightCost:35000, star:4.0, themes:["ê°€ì„±ë¹„"], fomo:72 },
    ];

    let PLACES = [...MOCK_PLACES];
    let HOTELS = [...MOCK_HOTELS];

    const EMOTIONS = ["ìš°ìš¸","ë¬´ê¸°ë ¥","ì„¤ë ˜","ì§€ì¹¨","ë‹µë‹µ","ì™¸ë¡œì›€","í–‰ë³µ","ì§œì¦","ê¶Œíƒœ","íë§"];
    const EMOTION_TO_THEMES = {
      "ìš°ìš¸":["ìœ„ë¡œ","íë§","ì •í™”"],
      "ë¬´ê¸°ë ¥":["ì„¤ë ˜","ë·°","í™œê¸°"],
      "ì„¤ë ˜":["ì„¤ë ˜","ë·°"],
      "ì§€ì¹¨":["íë§","ì‚¬ìƒ‰"],
      "ë‹µë‹µ":["ì‚°ì±…","ì •í™”"],
      "ì™¸ë¡œì›€":["ê°ì„±","ìœ„ë¡œ"],
      "í–‰ë³µ":["íŠ¸ë Œë“œ","ë·°"],
      "ì§œì¦":["ì‚¬ìƒ‰","ì •í™”"],
      "ê¶Œíƒœ":["íŠ¸ë Œë“œ","í™œê¸°"],
      "íë§":["íë§","ì‚¬ìƒ‰"],
    };

    // ===== DOM =====
    const chips = document.getElementById('emotionChips');
    const customEmotion = document.getElementById('customEmotion');
    const weatherSel = document.getElementById('weather');
    const inoutSel = document.getElementById('inout');
    const budgetInp = document.getElementById('budget');
    const tripModeSel = document.getElementById('tripMode');
    const listPlacesEl = document.getElementById('listPlaces');
    const listHotelsEl = document.getElementById('listHotels');
    const statusEl = document.getElementById('status');
    const routeEl = document.getElementById('route');
    const planCostEl = document.getElementById('planCost');
    const sidoSel = document.getElementById('sido');
    const btnAreaLoad = document.getElementById('btnAreaLoad');
    const strictBudgetChk = document.getElementById('strictBudget');

    // ê°ì • chips
    let selectedEmotion = null;
    EMOTIONS.forEach(e => {
      const b = document.createElement('button');
      b.className = 'chip';
      b.textContent = e;
      b.onclick = () => { selectedEmotion = e; highlightChips(e); };
      chips.appendChild(b);
    });
    function highlightChips(val){
      [...chips.children].forEach(c=> c.classList.toggle('chip--active', c.textContent===val));
    }

    // ì§€ë„
    let map, markersLayer, routeLine;
    function initMap(){
      map = L.map('map').setView([CENTER.lat, CENTER.lng], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19, attribution:'Â© OpenStreetMap'}).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
    }
    initMap();

    function setMapCenter(lat, lng, zoom=12){ map.setView([lat,lng], zoom); }

    // ===== ë¹„ìš© ì¶”ì • =====
    function estimatePlaceCost(title="", type="outdoor", ctid=""){
      const t = title || "";
      if (ctid==="14" || /ë°•ë¬¼ê´€|ë¯¸ìˆ ê´€|ì „ì‹œ|ê¸°ë…ê´€/.test(t)) return 5000 + Math.floor(Math.random()*7000);
      if (ctid==="28" || /ì²´í—˜|í…Œë§ˆ|VR|AR|ì¹´íŠ¸|ì„œí•‘|ì•„ì¿ ì•„ë¦¬ì›€|ì¼€ì´ë¸”ì¹´|ì „ë§ëŒ€/.test(t)) return 12000 + Math.floor(Math.random()*14000);
      if (/íƒ€ì›Œ|ì „ë§|Níƒ€ì›Œ|ì„œìš¸íƒ€ì›Œ/.test(t)) return 15000 + Math.floor(Math.random()*8000);
      if (/ê³µì›|ìˆ²|ì‚°ì±…|ì²œ|ê°•|í˜¸ìˆ˜|í•´ë³€|ì˜¤ë¦„|ì‹œì¥|ê±°ë¦¬|ë‘˜ë ˆê¸¸|ì„±ê³½ê¸¸/.test(t)) return Math.random()<0.5?0:1000+Math.floor(Math.random()*2000);
      if (/ê¶|ê³ ê¶|ì™•ë¦‰|ì‚¬ì°°|í•œì˜¥|ë¬¸í™”ì¬/.test(t)) return Math.floor(Math.random()*4000);
      if (/ë°±í™”ì |ì•„ìš¸ë ›|ëª°|ë”í˜„ëŒ€|í”Œë˜ê·¸ì‹­|ì‡¼í•‘|ë§ˆì¼“/.test(t)) return 0;
      return type==='indoor' ? 6000 + Math.floor(Math.random()*9000) : (Math.random()<0.7?0:1000+Math.floor(Math.random()*3000));
    }
    function estimateHotelNight(title=""){
      const t = title || "";
      if (/ë¦¬ì¡°íŠ¸|ìŠ¤íŒŒ|í”„ë¦¬ë¯¸ì–´|ìˆ˜ì˜ì¥|ì½˜ë„/.test(t)) return 120000 + Math.floor(Math.random()*80000); // 12~20ë§Œ+
      if (/í˜¸í…”|í˜¸í…”ìŠ¤|ê´€ê´‘í˜¸í…”|í•´ìš´ëŒ€|ì‹œí‹°/.test(t)) return 80000 + Math.floor(Math.random()*60000); // 8~14ë§Œ
      if (/í•œì˜¥|ìŠ¤í…Œì´|íœì…˜|ê²ŒìŠ¤íŠ¸|ë¯¼ë°•|í˜¸ìŠ¤í…”/.test(t)) return 40000 + Math.floor(Math.random()*40000); // 4~8ë§Œ
      return 70000 + Math.floor(Math.random()*60000);
    }

    // ===== í…Œë§ˆ ì¶”ë¡  =====
    function deriveThemesFromTitle(t=''){
      const tags = [];
      if (/ê³µì›|ìˆ²|ì‚°ì±…|ì²œ|í˜¸ìˆ˜|ì„¬|ì˜¤ë¦„|ì„±ê³½ê¸¸|ë‘˜ë ˆê¸¸/.test(t)) tags.push('ì‚°ì±…','íë§');
      if (/íƒ€ì›Œ|ì „ë§|ìŠ¤ì¹´ì´|ë·°|í¬í† |ì•¼ê²½/.test(t)) tags.push('ë·°','ì„¤ë ˜');
      if (/ë°•ë¬¼ê´€|ë¯¸ìˆ ê´€|ì—­ì‚¬|ê¶|ì„±|ì „ì‹œ|ê¸°ë…ê´€/.test(t)) tags.push('ì—­ì‚¬','ì‚¬ìƒ‰');
      if (!tags.length) tags.push('íŠ¸ë Œë“œ');
      return Array.from(new Set(tags));
    }

    // ===== ë§¤í•‘ =====
    function mapItemsToPlaces(items){
      return (items||[]).map((it,idx)=>{
        const typeGuess = (String(it.contenttypeid)==='14' || /ë°•ë¬¼ê´€|ë¯¸ìˆ ê´€|ì „ì‹œ/.test(it.title)) ? 'indoor' : 'outdoor';
        const cost = estimatePlaceCost(it.title||"", typeGuess, String(it.contenttypeid||""));
        return {
          id: idx+1,
          name: it.title,
          lat: Number(it.mapy), lng: Number(it.mapx),
          type: typeGuess, cost,
          themes: deriveThemesFromTitle(it.title||""), fomo: 70 + (idx%25)
        };
      }).filter(p=>isFinite(p.lat)&&isFinite(p.lng));
    }
    function mapItemsToHotels(items){
      return (items||[]).map((it,idx)=>{
        const nightCost = estimateHotelNight(it.title||"");
        return {
          id: 1000+idx+1,
          name: it.title, type:"hotel",
          lat: Number(it.mapy), lng: Number(it.mapx),
          nightCost, star: 4.0 + (idx%10)/10,
          themes:["í¸ì•ˆ","ì ‘ê·¼ì„±"], fomo: 70 + (idx%25)
        };
      }).filter(h=>isFinite(h.lat)&&isFinite(h.lng));
    }

    // ===== ë°ì´í„° ë¡œë”© =====
    async function loadPlacesByArea(areaCode){
      const u = new URL(TOURAPI_PROXY, location.origin);
      u.searchParams.set("by","area"); u.searchParams.set("areaCode", String(areaCode));
      u.searchParams.set("numOfRows","120"); // ê´€ê´‘ì§€(ê¸°ë³¸=12)
      try{ const r=await fetch(u); const data=await r.json();
        const items = data?.response?.body?.items?.item || [];
        PLACES = mapItemsToPlaces(items);
        return PLACES.length;
      }catch(e){ console.error(e); PLACES=[...MOCK_PLACES]; return 0; }
    }
    async function loadHotelsByArea(areaCode){
      const u = new URL(TOURAPI_PROXY, location.origin);
      u.searchParams.set("by","area"); u.searchParams.set("areaCode", String(areaCode));
      u.searchParams.set("contentTypeId","32"); // ìˆ™ë°•
      u.searchParams.set("numOfRows","120");
      try{ const r=await fetch(u); const data=await r.json();
        const items = data?.response?.body?.items?.item || [];
        HOTELS = mapItemsToHotels(items);
        return HOTELS.length;
      }catch(e){ console.error(e); HOTELS=[...MOCK_HOTELS]; return 0; }
    }

    // ===== ì¶”ì²œ ë¡œì§ =====
    function tripMeta(){
      const mode = tripModeSel.value;
      const nights = mode==="1n2d"?1 : mode==="2n3d"?2 : 0;
      const days = nights>0 ? nights+1 : 1;
      const activitySlotsPerDay = nights>0 ? 4 : 3; // ê°„ë‹¨ ê°€ì •
      const maxPlaces = days * activitySlotsPerDay;
      return { mode, nights, days, maxPlaces };
    }

    function scorePlace(p, themes, weather){
      const themeHit = themes.some(t=>p.themes.includes(t)) ? 8 : 0;
      const fomo = p.fomo/10;
      const weatherBoost = (weather==='rainy' && p.type==='indoor') ? 6 : (weather==='sunny' && p.type==='outdoor') ? 4 : 0;
      const soft = (p.cost||0) > 0 ? - ((p.cost||0) >= 18000 ? 3 : ((p.cost||0) >= 10000 ? 1 : 0)) : 1;
      return themeHit + weatherBoost + fomo + soft;
    }
    function scoreHotel(h){
      const base = h.fomo/10 + (h.star||4);
      return base; // ì‹¬í”Œ: í‰ì /ì¸ê¸°ë„ ê¸°ë°˜
    }

    function pickByBudgetAndScore(pool, budgetCap, maxItems, strict=false, perItemCeil=Infinity){
      if (!pool.length) return [];
      let filtered = pool.filter(x => (x.cost||0) <= perItemCeil);
      let relax=0; while(filtered.length < Math.max(6, maxItems*2) && relax<3){ relax++; filtered = pool.filter(x => (x.cost||0)<=perItemCeil*(1+0.15*relax)); }
      const freeFirst = filtered.filter(x => (x.cost||0)===0).slice(0, Math.min(3, maxItems));
      let remainBudget = budgetCap - freeFirst.reduce((s,x)=>s+(x.cost||0),0);
      let remainSlots = maxItems - freeFirst.length;
      const candidates = filtered.filter(x=>!freeFirst.find(f=>f.id===x.id)).sort((a,b)=>{
        const ra = (a.cost||0)>0 ? (a.score/a.cost) : a.score*10, rb = (b.cost||0)>0 ? (b.score/b.cost) : b.score*10;
        return rb-ra;
      });
      const chosen=[...freeFirst];
      for(const c of candidates){
        if(remainSlots<=0) break;
        const price=c.cost||0;
        if(price<=remainBudget){ chosen.push(c); remainBudget-=price; remainSlots--; }
        else if(!strict && chosen.length===0 && budgetCap>0 && price<=budgetCap*1.1){ chosen.push(c); break; }
      }
      if(chosen.length<Math.max(2,Math.floor(maxItems/2))){
        const cheap=candidates.filter(x=>!chosen.find(y=>y.id===x.id)).sort((a,b)=>(a.cost||0)-(b.cost||0));
        for(const c of cheap){ if(chosen.length>=maxItems) break; const price=c.cost||0; if(price<=remainBudget){ chosen.push(c); remainBudget-=price; } }
      }
      if(chosen.length<maxItems){
        const moreFree=filtered.filter(x=>(x.cost||0)===0 && !chosen.find(y=>y.id===x.id));
        for(const f of moreFree){ if(chosen.length>=maxItems) break; chosen.push(f); }
      }
      return chosen.slice(0,maxItems);
    }
    function pickHotelsByBudget(pool, nights, hotelBudget, strict=false){
      if(nights<=0) return [];
      // 1ë°•ë‹¹ ìƒí•œê°€
      const perNight = nights>0 ? Math.max(30000, Math.floor(hotelBudget/nights)) : 0;
      let filtered = pool.filter(h => (h.nightCost||0) <= perNight*1.15); // 15% ë§ˆì§„
      if(filtered.length===0) filtered = pool.sort((a,b)=> (a.nightCost||0)-(b.nightCost||0)).slice(0,10);
      // ì ìˆ˜ìˆœ(ê°€ì„±ë¹„ ê°€ì¤‘)
      filtered.forEach(h=> h.score = scoreHotel(h) + (h.nightCost>0 ? 30_000/(h.nightCost) : 0));
      const sorted = filtered.sort((a,b)=> b.score - a.score);
      const top = sorted.slice(0, Math.min(nights, 3)); // ë°¤ ìˆ˜ë§Œí¼(ìµœëŒ€ 2ë°•3ì¼ = 2ê°œ)
      // ì˜ˆì‚° ì—„ìˆ˜: ì´ ìˆ™ë°•ë¹„ <= hotelBudget
      let chosen = [];
      let remain = hotelBudget;
      for(const h of top){
        if((h.nightCost||0)<=remain || !strict){ chosen.push(h); remain -= (h.nightCost||0); }
      }
      // ë¶€ì¡±í•˜ë©´ ë” ì‹¼ ìˆ™ì†Œë¡œ êµì²´ ì‹œë„
      if(strict){
        let total = chosen.reduce((s,h)=>s+(h.nightCost||0),0);
        if(total>hotelBudget){
          const cheap = pool.sort((a,b)=>(a.nightCost||0)-(b.nightCost||0));
          chosen = [];
          for(let i=0;i<nights;i++){
            const c = cheap.find(x=> (chosen.indexOf(x)===-1) && (x.nightCost||0) <= (hotelBudget - chosen.reduce((s,h)=>s+(h.nightCost||0),0) - (nights-i-1)*30000 ) );
            chosen.push(c || cheap[0]);
          }
        }
      }
      return chosen.slice(0, nights);
    }

    // ===== ë©”ì¸ í•„í„° =====
    function filterByInputs(){
      const emotion = selectedEmotion || customEmotion.value.trim();
      const themes = EMOTION_TO_THEMES[emotion] || [emotion].filter(Boolean);
      const weather = weatherSel.value;
      const inout = inoutSel.value;
      const budget = Number(budgetInp.value||0);
      const strict = !!strictBudgetChk?.checked;
      const {nights, days, maxPlaces, mode} = tripMeta();

      // ì˜ˆì‚° ë¶„ë°°: ìˆ™ë°• 60%, ì•¡í‹°ë¹„í‹° 40% (ìˆ™ë°• ì—†ìœ¼ë©´ 0/100)
      const hotelBudget = nights>0 ? Math.floor(budget * 0.6) : 0;
      const actBudget = budget - hotelBudget;

      const placesScored = PLACES
        .filter(p => inout==='any' ? true : p.type===inout)
        .map(p => ({...p, score: scorePlace(p, themes, weather)}))
        .sort((a,b)=> b.score - a.score);

      const actCap = Math.max(0, Math.floor(actBudget * 0.7)); // ì•¡í‹°ë¹„í‹°ë„ ì—¬ìœ  30%
      const perItemCeil = maxPlaces>0 ? Math.max(3000, Math.floor(actCap / maxPlaces * 1.2)) : Infinity;
      const chosenPlaces = pickByBudgetAndScore(placesScored.slice(0,50), actCap, maxPlaces, strict, perItemCeil);
      const actTotal = chosenPlaces.reduce((s,p)=>s+(p.cost||0),0);

      // í˜¸í…” ì„ íƒ
      const hotelsScored = HOTELS.map(h=> ({...h, score: scoreHotel(h)})).sort((a,b)=> b.score - a.score);
      const chosenHotels = pickHotelsByBudget(hotelsScored, nights, hotelBudget, strict);
      const hotelTotal = chosenHotels.reduce((s,h)=>s+(h.nightCost||0),0);

      const grandTotal = actTotal + hotelTotal;

      return {
        places: chosenPlaces,
        hotels: chosenHotels,
        meta:{emotion, weather, inout, nights, days, maxPlaces, mode},
        money:{budget, hotelBudget, actBudget, actCap, perItemCeil, actTotal, hotelTotal, grandTotal},
        strict
      };
    }

    // ===== ë Œë”ë§ =====
    function renderLists(places, hotels){
      // ì§€ë„ ì´ˆê¸°í™”
      markersLayer.clearLayers();
      listPlacesEl.innerHTML = '';
      listHotelsEl.innerHTML = '';

      places.forEach(p=>{
        const li = document.createElement('li');
        li.className = "p-2 rounded-xl hover:bg-slate-50";
        li.innerHTML = `
          <div class="flex items-start gap-3">
            <div class="w-10 h-10 flex items-center justify-center rounded-xl bg-sky-50 text-sky-700 font-bold">${Math.round(p.fomo)}</div>
            <div class="flex-1">
              <div class="font-semibold">${p.name}</div>
              <div class="text-xs text-gray-500">${p.type==='indoor'?'ì‹¤ë‚´':'ì‹¤ì™¸'} Â· ~${(p.cost||0).toLocaleString()}ì› Â· í…Œë§ˆ: ${p.themes.join(', ')}</div>
            </div>
            <button class="btn btn-outline" onclick='addPlaceToPlan(${p.id})'>ì¶”ê°€</button>
          </div>`;
        listPlacesEl.appendChild(li);
        const m = L.marker([p.lat,p.lng]).bindPopup(p.name);
        markersLayer.addLayer(m);
      });

      hotels.forEach(h=>{
        const li = document.createElement('li');
        li.className = "p-2 rounded-xl hover:bg-slate-50";
        li.innerHTML = `
          <div class="flex items-start gap-3">
            <div class="w-10 h-10 flex items-center justify-center rounded-xl bg-sky-50 text-sky-700 font-bold">ğŸ¨</div>
            <div class="flex-1">
              <div class="font-semibold">${h.name}</div>
              <div class="text-xs text-gray-500">1ë°• ~${(h.nightCost||0).toLocaleString()}ì› Â· í‰ì  ${h.star?.toFixed(1) ?? '4.0'}</div>
            </div>
            <button class="btn btn-outline" onclick='addHotelToPlan(${h.id})'>ì¶”ê°€</button>
          </div>`;
        listHotelsEl.appendChild(li);
        const m = L.marker([h.lat,h.lng]).bindPopup("ğŸ¨ "+h.name);
        markersLayer.addLayer(m);
      });

      // ì§€ë„ í¬ì»¤ìŠ¤
      const first = places[0] || hotels[0];
      if(first) map.setView([first.lat, first.lng], 12);
    }

    // ===== í”Œëœ êµ¬ì„± =====
    const plan = { places:[], hotels:[] }; // hotelsëŠ” {nightIndex:0|1, ...}
    window.addPlaceToPlan = function(id){
      const p = PLACES.find(x=>x.id===id);
      if(!p) return;
      if(plan.places.find(x=>x.id===id)) return;
      plan.places.push(p);
      renderPlan();
    };
    window.addHotelToPlan = function(id){
      const h = HOTELS.find(x=>x.id===id);
      if(!h) return;
      // ìë™ìœ¼ë¡œ 1ë²ˆì§¸ ë°¤ë¶€í„° ì±„ìš°ê¸°
      const { nights } = tripMeta();
      for(let i=0;i<nights;i++){
        if(!plan.hotels.find(x=>x.nightIndex===i)){
          plan.hotels.push({...h, nightIndex:i});
          break;
        }
      }
      renderPlan();
    };

    function renderPlan(){
      const { nights, days } = tripMeta();
      routeEl.innerHTML = '';
      let totalAct=0, totalHotel=0;

      // ì¼ìë³„ ì¶œë ¥
      for(let d=0; d<days; d++){
        const dayHeader = document.createElement('li');
        dayHeader.className = 'mb-1 font-semibold';
        dayHeader.textContent = `Day ${d+1}`;
        routeEl.appendChild(dayHeader);

        // ë‹¹ì¼ì€ ìˆ™ì†Œ í‘œì‹œ ì—†ìŒ, 1ë°• ì´ìƒì´ë©´ Day1 ë°¤ë¶€í„°
        const hotelForNight = plan.hotels.find(h => h.nightIndex===d);
        const dayPlaces = plan.places.slice(d*4, d*4+4); // ëŒ€ëµ 4ê³³/ì¼

        dayPlaces.forEach((p, i)=>{
          const li = document.createElement('li');
          li.className = 'ml-4 mb-1';
          li.textContent = `â€¢ ${p.name} (~${(p.cost||0).toLocaleString()}ì›)`;
          routeEl.appendChild(li);
          totalAct += (p.cost||0);
        });

        if(hotelForNight){
          const li = document.createElement('li');
          li.className = 'ml-4 mb-1';
          li.textContent = `ğŸ¨ ìˆ™ì†Œ: ${hotelForNight.name} (1ë°• ~${(hotelForNight.nightCost||0).toLocaleString()}ì›)`;
          routeEl.appendChild(li);
          totalHotel += (hotelForNight.nightCost||0);
        }
      }

      planCostEl.textContent = `ì´ ì˜ˆìƒë¹„: ì•¡í‹°ë¹„í‹° ~${totalAct.toLocaleString()}ì› + ìˆ™ë°• ~${totalHotel.toLocaleString()}ì› = í•©ê³„ ~${(totalAct+totalHotel).toLocaleString()}ì›`;
      drawRoute();
    }

    function drawRoute(){
      if(routeLine){ map.removeLayer(routeLine); routeLine=null; }
      const pts = [...plan.places, ...plan.hotels];
      if(pts.length < 2) return;
      const latlngs = pts.map(p => [p.lat,p.lng]);
      routeLine = L.polyline(latlngs, {weight:5, opacity:.9, color:'#0ea5e9'}).addTo(map);
      map.fitBounds(routeLine.getBounds(), {padding:[20,20]});
    }

    // ===== ì´ë²¤íŠ¸ =====
    document.getElementById('btnRecommend').onclick = ()=>{
      const out = filterByInputs();
      renderLists(out.places, out.hotels);
      statusEl.textContent =
        `ì¶”ì²œ: ì•¡í‹°ë¹„í‹° ${out.places.length} Â· ìˆ™ì†Œ ${out.hotels.length} | ì•¡í‹°ë¹„í‹°ìº¡ ${out.money.actCap.toLocaleString()}ì› (ìƒí•œ ${out.money.perItemCeil.toLocaleString()}ì›) Â· ìˆ™ë°•ì˜ˆì‚° ${out.money.hotelBudget.toLocaleString()}ì› | ì˜ˆìƒí•©ê³„ ~${out.money.grandTotal.toLocaleString()}ì›`;
    };

    document.getElementById('btnRoute').onclick = ()=>{
      const out = filterByInputs();
      // ìë™ í”Œëœ ì±„ìš°ê¸°: ì¶”ì²œ ê²°ê³¼ë¥¼ ë°”ë¡œ ë°˜ì˜
      plan.places = [...out.places];
      plan.hotels = out.hotels.map((h, i)=> ({...h, nightIndex:i}));
      renderPlan();
      statusEl.textContent =
        `ë£¨íŠ¸ ìƒì„±: ${plan.places.length}ê³³ + ìˆ™ì†Œ ${plan.hotels.length} | í•©ê³„ ~${out.money.grandTotal.toLocaleString()}ì›`;
    };

    document.getElementById('btnQuick').onclick = async ()=>{
      selectedEmotion = 'ì„¤ë ˜'; highlightChips('ì„¤ë ˜');
      weatherSel.value='sunny'; inoutSel.value='any'; budgetInp.value=200000; tripModeSel.value='1n2d';
      strictBudgetChk.checked = false;
      const { scored } = await initialLoadIfNeeded(); // ë°ì´í„° ì¤€ë¹„
      const out = filterByInputs();
      renderLists(out.places, out.hotels);
      plan.places = [...out.places];
      plan.hotels = out.hotels.map((h,i)=> ({...h, nightIndex:i}));
      renderPlan();
      statusEl.textContent = `ë¹ ë¥¸ì²´í—˜: 1ë°•2ì¼ Â· í•©ê³„ ~${out.money.grandTotal.toLocaleString()}ì›`;
    };

    document.getElementById('btnSave').onclick = ()=>{
      localStorage.setItem('trendtrip_plan_v2', JSON.stringify(plan));
      alert('í”Œëœì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    };
    document.getElementById('btnLoad').onclick = ()=>{
      const raw = localStorage.getItem('trendtrip_plan_v2');
      if(!raw){ alert('ì €ì¥ëœ í”Œëœì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
      const data = JSON.parse(raw)||{};
      plan.places = data.places||[]; plan.hotels = data.hotels||[];
      renderPlan();
      statusEl.textContent='ì €ì¥ëœ í”Œëœì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.';
    };

    btnAreaLoad.addEventListener('click', async ()=>{
      const opt = sidoSel.selectedOptions[0];
      const areaCode = opt.value;
      const [lat, lng] = opt.dataset.center.split(',').map(Number);
      statusEl.textContent = 'ì§€ì—­ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦';
      const n1 = await loadPlacesByArea(areaCode);
      const n2 = await loadHotelsByArea(areaCode);
      setMapCenter(lat, lng, 11);
      const out = filterByInputs();
      renderLists(out.places, out.hotels);
      statusEl.textContent = `${opt.text} ë¡œë“œ: ì¥ì†Œ ${n1} Â· ìˆ™ì†Œ ${n2} / ì¶”ì²œ ë°˜ì˜: í•©ê³„ ~${out.money.grandTotal.toLocaleString()}ì›`;
    });

    async function initialLoadIfNeeded(){
      if(PLACES===MOCK_PLACES) await loadPlacesByArea(sidoSel.value||1);
      if(HOTELS===MOCK_HOTELS) await loadHotelsByArea(sidoSel.value||1);
      return { scored:true };
    }

    // ì´ˆê¸° ì§„ì…: ì„œìš¸
    (async ()=>{
      await loadPlacesByArea(1);
      await loadHotelsByArea(1);
      const out = filterByInputs();
      renderLists(out.places, out.hotels);
      statusEl.textContent = `ì´ˆê¸° ì¶”ì²œ: ì•¡í‹°ë¹„í‹° ${out.places.length} Â· ìˆ™ì†Œ ${out.hotels.length} Â· ì˜ˆìƒí•©ê³„ ~${out.money.grandTotal.toLocaleString()}ì›`;
    })();
  </script>
</body>
</html>