<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TrendTrip | ê°ì •Â·íŠ¸ë Œë“œÂ·ì˜ˆì‚° ê¸°ë°˜ ì—¬í–‰ ì¶”ì²œ</title>
  <meta name="description" content="ê°ì •Â·íŠ¸ë Œë“œÂ·ì˜ˆì‚°Â·ë‚ ì”¨ë¥¼ ë°˜ì˜í•´ ë§ì¶¤ ì—¬í–‰ ì½”ìŠ¤ì™€ ë£¨íŠ¸ë¥¼ ì¶”ì²œí•©ë‹ˆë‹¤." />
  <meta name="keywords" content="ì—¬í–‰, ì¶”ì²œ, ê°ì •, íŠ¸ë Œë“œ, ì˜ˆì‚°, ì½”ìŠ¤, ë£¨íŠ¸, ê´€ê´‘, í•œêµ­ê´€ê´‘ê³µì‚¬, TourAPI" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2280%22>ğŸ§­</text></svg>">
  <meta property="og:title" content="TrendTrip" />
  <meta property="og:description" content="ê°ì •Â·íŠ¸ë Œë“œÂ·ì˜ˆì‚°ì„ ë°˜ì˜í•œ ë§ì¶¤ ì—¬í–‰ ì½”ìŠ¤" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://dummyimage.com/1200x630/0ea5e9/ffffff&text=TrendTrip" />
  <meta name="theme-color" content="#0ea5e9">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{ --brand:#0ea5e9 }
    html,body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif}
    .chip{padding:.4rem .9rem;border:1px solid #e5e7eb;border-radius:9999px;cursor:pointer;transition:.15s}
    .chip:hover{background:#f8fafc}
    .chip--active{background:#e0f2fe;border-color:#7dd3fc}
    .card{border-radius:1.25rem;box-shadow:0 8px 30px rgba(2,132,199,.08);padding:1.1rem;background:#fff}
    .btn{padding:.65rem 1rem;border-radius:.9rem;font-weight:700;transition:.12s;display:inline-flex;align-items:center;gap:.5rem}
    .btn:hover{transform:translateY(-1px)}
    .btn-primary{background:var(--brand);color:#fff}
    .btn-outline{background:#fff;border:1px solid #e5e7eb}
    .badge{padding:.25rem .55rem;border-radius:.5rem;background:#f1f5f9;font-size:.7rem}
    .glass{background:linear-gradient(180deg,rgba(255,255,255,.75),rgba(255,255,255,.6));backdrop-filter:saturate(160%) blur(8px);border:1px solid rgba(255,255,255,.3);border-radius:1.25rem}
    .section{scroll-margin-top:80px}
  </style>
</head>
<body class="bg-gradient-to-b from-sky-50 via-white to-white text-gray-800">

  <!-- Header -->
  <header class="sticky top-0 z-40">
    <div class="glass max-w-7xl mx-auto my-3 px-4 py-3 flex items-center justify-between">
      <a href="#" class="flex items-center gap-2 font-extrabold text-lg">
        <span class="text-2xl">ğŸ§­</span> TrendTrip
      </a>
      <nav class="hidden sm:flex gap-2 text-sm">
        <a class="chip" href="#features">ê¸°ëŠ¥</a>
        <a class="chip" href="#discover">ì¶”ì²œ</a>
        <a class="chip" href="#map">ì§€ë„</a>
        <a class="chip" href="#plan">ë‚´ í”Œëœ</a>
      </nav>
    </div>
  </header>

  <!-- Hero -->
  <section class="section" id="home">
    <div class="max-w-7xl mx-auto px-4 pt-8 pb-12 grid md:grid-cols-2 gap-8 items-center">
      <div>
        <span class="badge">ê°ì •Â·íŠ¸ë Œë“œÂ·ì˜ˆì‚° ê¸°ë°˜</span>
        <h1 class="text-4xl md:text-5xl font-extrabold leading-tight mt-3">
          ì˜¤ëŠ˜ì˜ ê¸°ë¶„ìœ¼ë¡œ ì‹œì‘í•˜ëŠ”<br><span class="text-sky-600">ë§ì¶¤ ì—¬í–‰ ì½”ìŠ¤</span>
        </h1>
        <p class="text-gray-600 mt-4">
          ê°ì • í‚¤ì›Œë“œ, í˜„ì¬ ë‚ ì”¨, ì˜ˆì‚°ê³¼ ì‹œê°„ì„ ë°˜ì˜í•´ ì½”ìŠ¤ í›„ë³´ë¥¼ ì„ ë³„í•˜ê³ 
          ì§€ë„ ìœ„ ë™ì„ ê¹Œì§€ í•œ ë²ˆì— ë³´ì—¬ì¤ë‹ˆë‹¤.
        </p>
        <div class="mt-6 flex flex-wrap gap-3">
          <button id="btnQuick" class="btn btn-primary">ë¹ ë¥´ê²Œ ì²´í—˜í•˜ê¸°</button>
          <a class="btn btn-outline" href="#discover">ì¶”ì²œë¶€í„° ë³´ê¸°</a>
        </div>
        <p class="mt-3 text-xs text-gray-500">* ì‹¬ì‚¬ìš© ê³µê°œ ë²„ì „ â€” ì‹¤ì œ API ì „í™˜ ê°€ëŠ¥ êµ¬ì¡°</p>
      </div>
      <div class="card">
        <div class="grid grid-cols-2 gap-3">
          <div class="card"><div class="text-xs text-gray-500">ì…ë ¥</div><div class="font-semibold">ê°ì •Â·ë‚ ì”¨Â·ì˜ˆì‚°Â·ì‹œê°„</div></div>
          <div class="card"><div class="text-xs text-gray-500">ë¶„ì„</div><div class="font-semibold">ê°ì •â†’í…Œë§ˆ ë§¤í•‘</div></div>
          <div class="card"><div class="text-xs text-gray-500">ì¶”ì²œ</div><div class="font-semibold">FOMO+ì˜ˆì‚° ë°˜ì˜</div></div>
          <div class="card"><div class="text-xs text-gray-500">ê²°ê³¼</div><div class="font-semibold">ìµœì  ë£¨íŠ¸ & ì €ì¥</div></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Controls -->
  <section class="section" id="features">
    <div class="max-w-7xl mx-auto px-4 pb-6 grid md:grid-cols-3 gap-6">

      <!-- ê°ì • -->
      <div class="card">
        <h3 class="font-bold mb-3">1) ê°ì • ì…ë ¥</h3>
        <div id="emotionChips" class="flex flex-wrap gap-2"></div>
        <input id="customEmotion" class="mt-3 w-full border rounded-xl px-3 py-2" placeholder="ì§ì ‘ ì…ë ¥ (ì˜ˆ: ì„¤ë ˜, ë¬´ê¸°ë ¥)" />
      </div>

      <!-- ë‚ ì”¨/ì‹¤ë‚´ì™¸ -->
      <div class="card">
        <h3 class="font-bold mb-3">2) ë‚ ì”¨ & ì‹¤ë‚´/ì‹¤ì™¸</h3>
        <div class="flex items-center gap-2 mb-2">
          <label class="text-sm w-16">ë‚ ì”¨</label>
          <select id="weather" class="border rounded-xl px-3 py-2 flex-1">
            <option value="sunny">ë§‘ìŒ</option>
            <option value="cloudy">íë¦¼</option>
            <option value="rainy">ë¹„</option>
          </select>
        </div>
        <div class="flex items-center gap-2">
          <label class="text-sm w-16">ì„ í˜¸</label>
          <select id="inout" class="border rounded-xl px-3 py-2 flex-1">
            <option value="any">ìƒê´€ì—†ìŒ</option>
            <option value="indoor">ì‹¤ë‚´</option>
            <option value="outdoor">ì‹¤ì™¸</option>
          </select>
        </div>
      </div>

      <!-- ì˜ˆì‚°/ì‹œê°„ -->
      <div class="card">
        <h3 class="font-bold mb-3">3) ì˜ˆì‚° & ì‹œê°„</h3>
        <div class="flex items-center gap-2 mb-2">
          <label class="text-sm w-20">ì˜ˆì‚°(â‚©)</label>
          <input id="budget" type="number" class="border rounded-xl px-3 py-2 w-40" value="60000" />
        </div>
        <div class="flex items-center gap-2">
          <label class="text-sm w-20">ì‹œê°„</label>
          <select id="hours" class="border rounded-xl px-3 py-2 w-40">
            <option value="4">ë°˜ë‚˜ì ˆ(4h)</option>
            <option value="8" selected>í•˜ë£¨(8h)</option>
            <option value="12">ë„‰ë„‰íˆ(12h)</option>
          </select>
        </div>
      </div>
    </div>

    <!-- ì§€ì—­ ì„ íƒ -->
    <div class="max-w-7xl mx-auto px-4 pb-2">
      <div class="card flex flex-wrap items-center gap-3">
        <div class="font-bold mr-2">ì§€ì—­ ì„ íƒ</div>
        <select id="sido" class="border rounded-xl px-3 py-2">
          <option value="1"  data-center="37.5665,126.9780">ì„œìš¸íŠ¹ë³„ì‹œ</option>
          <option value="6"  data-center="35.1796,129.0756">ë¶€ì‚°ê´‘ì—­ì‹œ</option>
          <option value="39" data-center="33.4996,126.5312">ì œì£¼íŠ¹ë³„ìì¹˜ë„</option>
        </select>
        <button id="btnAreaLoad" class="btn btn-outline">ì§€ì—­ ë¶ˆëŸ¬ì˜¤ê¸°</button>

        <label class="ml-2 text-sm flex items-center gap-1">
          <input id="strictBudget" type="checkbox" class="scale-110" />
          ì˜ˆì‚° ì—„ìˆ˜
        </label>

        <div class="ml-auto flex gap-2">
          <button id="btnRecommend" class="btn btn-primary">ì¶”ì²œ ë³´ê¸°</button>
          <button id="btnRoute" class="btn btn-outline">ë£¨íŠ¸ ìƒì„±</button>
        </div>
        <span id="status" class="text-sm text-gray-500"></span>
      </div>
    </div>
  </section>

  <!-- Discover / Map -->
  <section class="section" id="discover">
    <div class="max-w-7xl mx-auto px-4 grid lg:grid-cols-2 gap-6">
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-bold">ì¶”ì²œ ì¥ì†Œ</h3>
          <span class="badge">FOMO ìƒìœ„ + ì˜ˆì‚° í•„í„°</span>
        </div>
        <ul id="list" class="space-y-3"></ul>
      </div>
      <div class="card" id="mapCard">
        <h3 class="font-bold mb-3">ì§€ë„</h3>
        <div id="map" class="w-full h-[440px] rounded-xl"></div>
      </div>
    </div>
  </section>

  <!-- Plan -->
  <section class="section" id="plan">
    <div class="max-w-7xl mx-auto px-4 my-6 card">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-bold">ë‚´ í”Œëœ</h3>
        <div class="flex gap-2">
          <button id="btnSave" class="btn btn-primary">ì €ì¥</button>
          <button id="btnLoad" class="btn btn-outline">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>
      </div>
      <ol id="route" class="list-decimal list-inside text-sm text-gray-700"></ol>
      <div id="planCost" class="mt-2 text-sm text-gray-600"></div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="mt-10 border-t">
    <div class="max-w-7xl mx-auto px-4 py-8 text-sm text-gray-500 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div>Â© <span id="yy"></span> TrendTrip. All rights reserved.</div>
      <div class="flex items-center gap-3">
        <span class="badge">ê³µê°œë²„ì „ Â· ìƒ˜í”Œë°ì´í„°</span>
        <a class="text-sky-600 hover:underline" href="#home">ë§¨ ìœ„ë¡œ</a>
      </div>
    </div>
  </footer>

  <script>
    // ===== ê¸°ë³¸ ì„¤ì • =====
    document.getElementById('yy').textContent = new Date().getFullYear();

    // ê°™ì€ ë„ë©”ì¸ ë°°í¬ ê¸°ì¤€(ê°•ì¶”). ë³„ë„ ë„ë©”ì¸ì´ë©´ ì ˆëŒ€ê²½ë¡œë¡œ êµì²´.
    const TOURAPI_PROXY = "/api/tourapi";

    // ì§€ë„ ì´ˆê¸° ì¤‘ì‹¬(ì„œìš¸ ì‹œì²­)
    const CENTER = { lat: 37.5665, lng: 126.9780 };

    // ì‹¤íŒ¨/ë¡œì»¬ í…ŒìŠ¤íŠ¸ ëŒ€ë¹„ ëª©ì—…
    const MOCK_PLACES = [
      { id:1, name:"ê²½ë³µê¶", lat:37.5796, lng:126.9770, type:"outdoor", cost:3000, themes:["ì—­ì‚¬","íë§"], fomo:88 },
      { id:2, name:"ë¶ì´Œí•œì˜¥ë§ˆì„", lat:37.5826, lng:126.9830, type:"outdoor", cost:0, themes:["ê°ì„±","ì‚°ì±…"], fomo:91 },
      { id:3, name:"ìµì„ ë™ ì¹´í˜", lat:37.5724, lng:126.9917, type:"indoor", cost:9000, themes:["ìœ„ë¡œ","ê°ì„±"], fomo:84 },
      { id:4, name:"êµ­ë¦½í˜„ëŒ€ë¯¸ìˆ ê´€ ì„œìš¸", lat:37.5790, lng:126.9803, type:"indoor", cost:6000, themes:["ì‚¬ìƒ‰","íë§"], fomo:76 },
      { id:5, name:"ì²­ê³„ì²œ ì‚°ì±…", lat:37.5690, lng:126.9780, type:"outdoor", cost:0, themes:["ì •í™”","ì‚°ì±…"], fomo:73 },
      { id:6, name:"ë¡¯ë°ì›”ë“œíƒ€ì›Œ ì „ë§ëŒ€", lat:37.5131, lng:127.1029, type:"indoor", cost:27000, themes:["ì„¤ë ˜","ë·°"], fomo:95 },
      { id:7, name:"í™ëŒ€ ìŠ¤íŠ¸ë¦¬íŠ¸", lat:37.5550, lng:126.9236, type:"outdoor", cost:0, themes:["í™œê¸°","íŠ¸ë Œë“œ"], fomo:90 },
      { id:8, name:"ë”í˜„ëŒ€ ì„œìš¸", lat:37.5261, lng:126.9287, type:"indoor", cost:0, themes:["íŠ¸ë Œë“œ","ì‹¤ë‚´"], fomo:86 },
      { id:9, name:"ë‚¨ì‚°ì„œìš¸íƒ€ì›Œ", lat:37.5512, lng:126.9882, type:"outdoor", cost:16000, themes:["ì„¤ë ˜","ë·°"], fomo:89 },
      { id:10,name:"DDP ì „ì‹œ", lat:37.5665, lng:127.0094, type:"indoor", cost:12000, themes:["ë¯¸ë˜","ë””ìì¸"], fomo:78 },
    ];
    let PLACES = [...MOCK_PLACES];

    const EMOTIONS = ["ìš°ìš¸","ë¬´ê¸°ë ¥","ì„¤ë ˜","ì§€ì¹¨","ë‹µë‹µ","ì™¸ë¡œì›€","í–‰ë³µ","ì§œì¦","ê¶Œíƒœ","íë§"];
    const EMOTION_TO_THEMES = {
      "ìš°ìš¸":["ìœ„ë¡œ","íë§","ì •í™”"],
      "ë¬´ê¸°ë ¥":["ì„¤ë ˜","ë·°","í™œê¸°"],
      "ì„¤ë ˜":["ì„¤ë ˜","ë·°"],
      "ì§€ì¹¨":["íë§","ì‚¬ìƒ‰"],
      "ë‹µë‹µ":["ì‚°ì±…","ì •í™”"],
      "ì™¸ë¡œì›€":["ê°ì„±","ìœ„ë¡œ"],
      "í–‰ë³µ":["íŠ¸ë Œë“œ","ë·°"],
      "ì§œì¦":["ì‚¬ìƒ‰","ì •í™”"],
      "ê¶Œíƒœ":["íŠ¸ë Œë“œ","í™œê¸°"],
      "íë§":["íë§","ì‚¬ìƒ‰"],
    };

    // ===== DOM =====
    const chips = document.getElementById('emotionChips');
    const customEmotion = document.getElementById('customEmotion');
    const weatherSel = document.getElementById('weather');
    const inoutSel = document.getElementById('inout');
    const budgetInp = document.getElementById('budget');
    const hoursSel = document.getElementById('hours');
    const listEl = document.getElementById('list');
    const statusEl = document.getElementById('status');
    const routeEl = document.getElementById('route');
    const planCostEl = document.getElementById('planCost');
    const sidoSel = document.getElementById('sido');
    const btnAreaLoad = document.getElementById('btnAreaLoad');
    const strictBudgetChk = document.getElementById('strictBudget');

    // ===== ê°ì • Chips =====
    let selectedEmotion = null;
    EMOTIONS.forEach(e => {
      const b = document.createElement('button');
      b.className = 'chip';
      b.textContent = e;
      b.onclick = () => { selectedEmotion = e; highlightChips(e); };
      chips.appendChild(b);
    });
    function highlightChips(val){
      [...chips.children].forEach(c=> c.classList.toggle('chip--active', c.textContent===val));
    }

    // ===== ì§€ë„ =====
    let map, markersLayer, routeLine;
    function initMap(){
      map = L.map('map').setView([CENTER.lat, CENTER.lng], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        maxZoom: 19, attribution: 'Â© OpenStreetMap'
      }).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
    }
    initMap();

    function setMapCenter(lat, lng, zoom=12){
      map.setView([lat, lng], zoom);
    }

    // ===== ë¹„ìš© ì¶”ì • (ê°•í™”íŒ) =====
    function estimateCostByMeta(title = "", type = "outdoor", contentTypeId = "") {
      const t = title || "";
      const ctid = String(contentTypeId || "");
      // contentTypeId íŒíŠ¸(12 ê´€ê´‘ì§€, 14 ë¬¸í™”ì‹œì„¤, 15 ì¶•ì œ/ê³µì—°/í–‰ì‚¬, 28 ë ˆí¬ì¸ , 38 ì‡¼í•‘ ë“±)
      if (ctid === "14" || /ë°•ë¬¼ê´€|ë¯¸ìˆ ê´€|ì „ì‹œ|ê¸°ë…ê´€|ì•„íŠ¸|ê°¤ëŸ¬ë¦¬/.test(t)) {
        return 5000 + Math.floor(Math.random()*7000); // 5,000~12,000
      }
      if (ctid === "28" || /ì²´í—˜|í…Œë§ˆíŒŒí¬|VR|AR|ìŠ¤ì¹´ì´|ì¹´íŠ¸|ì„œí•‘|ì§šë¼ì¸|ì•„ì¿ ì•„ë¦¬ì›€|ì¼€ì´ë¸”ì¹´|ì „ë§ëŒ€/.test(t)) {
        return 12000 + Math.floor(Math.random()*14000); // 12,000~26,000
      }
      if (/íƒ€ì›Œ|Níƒ€ì›Œ|ì„œìš¸íƒ€ì›Œ|ëœë“œë§ˆí¬|ì „ë§/.test(t)) return 15000 + Math.floor(Math.random()*8000);
      if (/ê³µì›|ìˆ²|ë‘˜ë ˆê¸¸|ì‚°ì±…|ì²œ|ê°•|í˜¸ìˆ˜|í•´ë³€|ì˜¤ë¦„|ì‚°|ì„±ê³½ê¸¸|ì‹œì¥|ê±°ë¦¬|ìŠ¤íŠ¸ë¦¬íŠ¸/.test(t)) return Math.random()<0.5 ? 0 : 1000+Math.floor(Math.random()*2000);
      if (/ê¶|ê³ ê¶|ì™•ë¦‰|ì‚¬ì°°|ì„±ì§€|ì ˆ|í•œì˜¥|ë¬¸í™”ì¬/.test(t)) return 0 + Math.floor(Math.random()*4000); // 0~4,000
      if (/ë°±í™”ì |ì•„ìš¸ë ›|ëª°|ë”í˜„ëŒ€|í”Œë˜ê·¸ì‹­|ì‡¼í•‘|ë§ˆì¼“|ìƒê°€/.test(t)) return 0; // ì…ì¥ ë¬´ë£Œ
      // íƒ€ì… ê¸°ë³¸ê°’: indoorëŠ” ê¸°ë³¸ ìœ ë£Œ, outdoorëŠ” ì†Œì•¡/ë¬´ë£Œ
      if (type === 'indoor') return 6000 + Math.floor(Math.random()*9000); // 6,000~15,000
      return Math.random()<0.7 ? 0 : (1000 + Math.floor(Math.random()*3000)); // 0~4,000
    }

    // ===== ì œëª© ê¸°ë°˜ í…Œë§ˆ ì¶”ë¡  =====
    function deriveThemesFromTitle(t=''){
      const tags = [];
      if (/ê³µì›|ìˆ²|ì‚°ì±…|ì²œ|í˜¸ìˆ˜|ì„¬|ì˜¤ë¦„|ì„±ê³½ê¸¸|ë‘˜ë ˆê¸¸/.test(t)) tags.push('ì‚°ì±…','íë§');
      if (/íƒ€ì›Œ|ì „ë§|ìŠ¤ì¹´ì´|ë·°|í¬í† |ì•¼ê²½/.test(t)) tags.push('ë·°','ì„¤ë ˜');
      if (/ë°•ë¬¼ê´€|ë¯¸ìˆ ê´€|ì—­ì‚¬|ê¶|ì„±|ì „ì‹œ|ê¸°ë…ê´€/.test(t)) tags.push('ì—­ì‚¬','ì‚¬ìƒ‰');
      if (!tags.length) tags.push('íŠ¸ë Œë“œ');
      return Array.from(new Set(tags));
    }

    // ===== TourAPI ê²°ê³¼ ë§¤í•‘ =====
    function mapItemsToPlaces(items){
      return (items || []).map((it, idx)=>{
        const typeGuess = (String(it.contenttypeid)==='14' || /ë°•ë¬¼ê´€|ë¯¸ìˆ ê´€|ì „ì‹œ/.test(it.title)) ? 'indoor' : 'outdoor';
        const themes = deriveThemesFromTitle(it.title || "");
        const cost = estimateCostByMeta(it.title || "", typeGuess, it.contenttypeid);
        return {
          id: idx+1,
          name: it.title,
          lat: Number(it.mapy),
          lng: Number(it.mapx),
          type: typeGuess,
          cost,
          themes,
          fomo: 70 + (idx % 25)
        };
      }).filter(p=>isFinite(p.lat)&&isFinite(p.lng));
    }

    // ===== TourAPI í˜¸ì¶œ =====
    async function loadPlacesByLocation(center=CENTER, radius=5000){
      const u = new URL(TOURAPI_PROXY, location.origin);
      u.searchParams.set("by","location");
      u.searchParams.set("mapX", center.lng);
      u.searchParams.set("mapY", center.lat);
      u.searchParams.set("radius", String(radius));
      try{
        const r = await fetch(u.toString());
        const data = await r.json();
        const items = data?.response?.body?.items?.item || [];
        PLACES = mapItemsToPlaces(items);
      }catch(e){
        console.error('TourAPI(location) error:', e);
        PLACES = [...MOCK_PLACES];
      }
    }

    async function loadPlacesByArea(areaCode, sigunguCode){
      const u = new URL(TOURAPI_PROXY, location.origin);
      u.searchParams.set("by","area");
      u.searchParams.set("areaCode", String(areaCode));
      if (sigunguCode) u.searchParams.set("sigunguCode", String(sigunguCode));
      u.searchParams.set("numOfRows","120");
      try{
        const r = await fetch(u.toString());
        const data = await r.json();
        const items = data?.response?.body?.items?.item || [];
        PLACES = mapItemsToPlaces(items);
        return PLACES.length;
      }catch(e){
        console.error('TourAPI(area) error:', e);
        PLACES = [...MOCK_PLACES];
        return 0;
      }
    }

    // ===== ì˜ˆì‚° ê¸°ë°˜ ì„ íƒ í•¨ìˆ˜ (ê°•í™”íŒ) =====
    function pickByBudgetAndScore(pool, budgetCap, maxPlaces, strict=false, perPlaceCeil=Infinity){
      if (!pool.length) return [];
      // perPlace ìƒí•œê°€ ì ìš©
      let filtered = pool.filter(p => (p.cost||0) <= perPlaceCeil);
      // ë„ˆë¬´ ì ê²Œ ë‚¨ìœ¼ë©´ ìƒí•œì„ 15%ì”© ì™„í™”í•˜ë©´ì„œ ìµœì†Œ 2*maxPlaces í™•ë³´ ì‹œë„
      let relax = 0;
      while (filtered.length < Math.max(8, maxPlaces*2) && relax < 3){
        relax++;
        filtered = pool.filter(p => (p.cost||0) <= perPlaceCeil*(1+0.15*relax));
      }

      // ë¬´ë£Œ ìš°ì„  í™•ë³´(ìµœëŒ€ 3ê³³)
      const freeFirst = filtered.filter(p => (p.cost||0) === 0).slice(0, Math.min(3, maxPlaces));
      let remainingBudget = budgetCap - freeFirst.reduce((s,p)=>s+(p.cost||0), 0);
      let remainingSlots = maxPlaces - freeFirst.length;

      // íš¨ìœ¨(ì ìˆ˜/ë¹„ìš©) ê¸°ì¤€ ê·¸ë¦¬ë””
      const candidates = filtered
        .filter(p => !freeFirst.find(f => f.id === p.id))
        .sort((a,b)=>{
          const ra = (a.cost||0) > 0 ? (a.score / a.cost) : a.score * 10;
          const rb = (b.cost||0) > 0 ? (b.score / b.cost) : b.score * 10;
          return rb - ra;
        });

      const chosen = [...freeFirst];
      for (const p of candidates){
        if (remainingSlots <= 0) break;
        const price = p.cost||0;
        if (price <= remainingBudget){
          chosen.push(p);
          remainingBudget -= price;
          remainingSlots -= 1;
        } else if (!strict && chosen.length === 0 && budgetCap > 0 && price <= budgetCap * 1.1) {
          // ì—„ìˆ˜ í•´ì œ ì‹œ, ê·¹ë‹¨ìƒí™©(ì•„ë¬´ê²ƒë„ ëª» ê³ ë¥¼ ë•Œ) 10% ì´ˆê³¼ í—ˆìš©
          chosen.push(p);
          remainingSlots -= 1;
          remainingBudget = -1;
          break;
        }
      }

      // ì €ê°€ ë³´ì¶©
      if (chosen.length < Math.max(2, Math.floor(maxPlaces/2))){
        const cheap = candidates
          .filter(p => !chosen.find(c=>c.id===p.id))
          .sort((a,b)=> (a.cost||0) - (b.cost||0));
        for (const c of cheap){
          if (chosen.length >= maxPlaces) break;
          const price = c.cost||0;
          if (price <= remainingBudget){
            chosen.push(c);
            remainingBudget -= price;
          }
        }
      }

      // ë¬´ë£Œë¡œ ì±„ìš°ê¸°
      if (chosen.length < maxPlaces){
        const moreFree = filtered
          .filter(p => (p.cost||0) === 0 && !chosen.find(c=>c.id===p.id));
        for (const f of moreFree){
          if (chosen.length >= maxPlaces) break;
          chosen.push(f);
        }
      }
      return chosen.slice(0, maxPlaces);
    }

    // ===== ì¶”ì²œ/í•„í„° =====
    function filterByInputs(){
      const emotion = selectedEmotion || customEmotion.value.trim();
      const themes = EMOTION_TO_THEMES[emotion] || [emotion].filter(Boolean);
      const weather = weatherSel.value;
      const inout = inoutSel.value;
      const budget = Number(budgetInp.value || 0);
      const strict = !!strictBudgetChk?.checked;

      const weatherBoost = (p)=>{
        if(weather==='rainy' && p.type==='indoor') return 6;
        if(weather==='sunny' && p.type==='outdoor') return 4;
        return 0;
      };
      const ioPass = (p)=> inout==='any' ? true : p.type===inout;

      const maxPlaces = Math.max(2, Math.min(6, Math.floor((Number(hoursSel.value)||8)/2)));

      const scoredAll = PLACES.map(p=>{
        const themeHit = themes.some(t=>p.themes.includes(t)) ? 8 : 0;
        const fomo = p.fomo/10;
        const soft = (p.cost||0) > 0 ? - ((p.cost||0) >= 18000 ? 3 : ((p.cost||0) >= 10000 ? 1 : 0)) : 1;
        const score = themeHit + weatherBoost(p) + fomo + soft;
        return {...p, score};
      }).filter(ioPass)
        .sort((a,b)=> b.score - a.score);

      // ì˜ˆì‚° ìº¡(ì‹ì‚¬/êµí†µ ì—¬ìœ ë¶„ ê³ ë ¤)
      const budgetCap = Math.max(0, Math.floor(budget * 0.7));
      // ì¥ì†Œë³„ ìƒí•œê°€: ì½”ìŠ¤ ìˆ˜ ê¸°ì¤€ ê· ë“± ë¶„ë°° + 15% ë§ˆì§„
      const perPlaceBase = maxPlaces > 0 ? (budgetCap / maxPlaces) : 0;
      const perPlaceCeil = perPlaceBase > 0 ? Math.max(3000, Math.floor(perPlaceBase * 1.15)) : (strict ? 0 : Infinity);

      // ìƒìœ„ Nê°œ(ì¡ìŒ ì œê±°)ì—ì„œ ì˜ˆì‚° ìµœì  ì„ íƒ
      const pool = scoredAll.slice(0, 50);
      const chosen = pickByBudgetAndScore(pool, budgetCap, maxPlaces, strict, perPlaceCeil);
      const totalCost = chosen.reduce((s,p)=>s+(p.cost||0), 0);

      return {
        scored: chosen,
        emotion, maxPlaces, totalCost, budgetCap, strict,
        debug: { poolSize: pool.length, perPlaceCeil }
      };
    }

    function renderList(items){
      listEl.innerHTML = '';
      markersLayer.clearLayers();
      items.forEach((p)=>{
        const li = document.createElement('li');
        li.className = "p-2 rounded-xl hover:bg-slate-50";
        li.innerHTML = `
          <div class="flex items-start gap-3">
            <div class="w-10 h-10 flex items-center justify-center rounded-xl bg-sky-50 text-sky-700 font-bold">${Math.round(p.fomo)}</div>
            <div class="flex-1">
              <div class="font-semibold">${p.name}</div>
              <div class="text-xs text-gray-500">${p.type==='indoor'?'ì‹¤ë‚´':'ì‹¤ì™¸'} Â· ì˜ˆìƒë¹„ìš© ~${(p.cost||0).toLocaleString()}ì› Â· í…Œë§ˆ: ${p.themes.join(', ')}</div>
            </div>
            <button class="btn btn-outline" onclick='addToPlan(${p.id})'>ì¶”ê°€</button>
          </div>`;
        listEl.appendChild(li);
        const m = L.marker([p.lat,p.lng]).bindPopup(p.name);
        markersLayer.addLayer(m);
      });
      if(items[0]) map.setView([items[0].lat, items[0].lng], 12);
    }

    // ===== í”Œëœ/ë£¨íŠ¸ =====
    const plan = [];
    function addToPlan(id){
      const p = PLACES.find(x=>x.id===id);
      if(!p) return;
      if(plan.find(x=>x.id===id)) return;
      plan.push(p);
      renderPlan();
    }
    function renderPlan(){
      routeEl.innerHTML = '';
      let total = 0;
      plan.forEach((p,i)=>{
        const li = document.createElement('li');
        li.className = 'mb-1';
        li.textContent = `${i+1}. ${p.name} (~${(p.cost||0).toLocaleString()}ì›)`;
        routeEl.appendChild(li);
        total += (p.cost||0);
      });
      planCostEl.textContent = `ì´ ì˜ˆìƒ ì½”ìŠ¤ë¹„: ~${total.toLocaleString()}ì›`;
      drawRoute();
    }
    function drawRoute(){
      if(routeLine){ map.removeLayer(routeLine); routeLine=null; }
      if(plan.length < 2) return;
      const latlngs = plan.map(p=> [p.lat,p.lng]);
      routeLine = L.polyline(latlngs, {weight:5, opacity:.9, color:'#0ea5e9'}).addTo(map);
      map.fitBounds(routeLine.getBounds(), {padding:[20,20]});
    }

    // ===== ì´ë²¤íŠ¸ =====
    document.getElementById('btnRecommend').onclick = ()=>{
      const {scored, emotion, totalCost, budgetCap, strict, debug} = filterByInputs();
      renderList(scored);
      const tag = strict ? " (ì˜ˆì‚° ì—„ìˆ˜)" : "";
      statusEl.textContent =
        `ì¶”ì²œ${tag}: ${scored.length}ê³³ Â· í•©ê³„ ~${(totalCost||0).toLocaleString()}ì› / ìº¡ ${budgetCap.toLocaleString()}ì› Â· ìƒí•œê°€ ${debug.perPlaceCeil.toLocaleString()}ì› Â· í’€ ${debug.poolSize}`;
    };

    document.getElementById('btnRoute').onclick = ()=>{
      const {scored, maxPlaces, totalCost, budgetCap, strict, debug} = filterByInputs();
      plan.splice(0, plan.length, ...scored.slice(0, Math.min(maxPlaces, scored.length)));
      renderPlan();
      const tag = strict ? " (ì˜ˆì‚° ì—„ìˆ˜)" : "";
      statusEl.textContent =
        `ë£¨íŠ¸ ìƒì„±${tag}: ${plan.length}ê³³ Â· í•©ê³„ ~${(totalCost||0).toLocaleString()}ì› / ìº¡ ${budgetCap.toLocaleString()}ì› Â· ìƒí•œê°€ ${debug.perPlaceCeil.toLocaleString()}ì›`;
    };

    document.getElementById('btnQuick').onclick = ()=>{
      selectedEmotion = 'ë¬´ê¸°ë ¥'; highlightChips('ë¬´ê¸°ë ¥');
      weatherSel.value = 'sunny'; inoutSel.value='any'; budgetInp.value=60000; hoursSel.value=8;
      strictBudgetChk.checked = false;
      const {scored, totalCost, budgetCap, debug} = filterByInputs();
      renderList(scored);
      plan.splice(0, plan.length, ...scored.slice(0,4));
      renderPlan();
      statusEl.textContent =
        `ë¹ ë¥¸ ì²´í—˜: ${plan.length}ê³³ Â· í•©ê³„ ~${(totalCost||0).toLocaleString()}ì› / ìº¡ ${budgetCap.toLocaleString()}ì› Â· ìƒí•œê°€ ${debug.perPlaceCeil.toLocaleString()}ì›`;
    };

    document.getElementById('btnSave').onclick = ()=>{
      localStorage.setItem('trendtrip_plan', JSON.stringify(plan));
      alert('í”Œëœì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    };
    document.getElementById('btnLoad').onclick = ()=>{
      const raw = localStorage.getItem('trendtrip_plan');
      if(!raw){ alert('ì €ì¥ëœ í”Œëœì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
      const items = JSON.parse(raw) || [];
      plan.splice(0, plan.length, ...items);
      renderPlan();
      statusEl.textContent='ì €ì¥ëœ í”Œëœì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.';
    };

    // ì§€ì—­ ë¶ˆëŸ¬ì˜¤ê¸°
    btnAreaLoad.addEventListener('click', async ()=>{
      const opt = sidoSel.selectedOptions[0];
      const areaCode = opt.value;
      const [lat, lng] = opt.dataset.center.split(',').map(Number);
      statusEl.textContent = 'ì§€ì—­ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦';
      const n = await loadPlacesByArea(areaCode);
      setMapCenter(lat, lng, 11);
      const { scored, totalCost, budgetCap, debug } = filterByInputs();
      renderList(scored);
      statusEl.textContent =
        `${opt.text} ë¡œë“œ: ${n}ê°œ Â· ì¶”ì²œ ${scored.length}ê³³ Â· í•©ê³„ ~${(totalCost||0).toLocaleString()}ì› / ìº¡ ${budgetCap.toLocaleString()}ì› Â· ìƒí•œê°€ ${debug.perPlaceCeil.toLocaleString()}ì›`;
    });

    // ìµœì´ˆ ì§„ì…
    (async ()=>{
      await loadPlacesByLocation(CENTER, 4000);
      const { scored, totalCost, budgetCap, debug } = filterByInputs();
      renderList(scored);
      statusEl.textContent =
        `ì´ˆê¸° ì¶”ì²œ: ${scored.length}ê³³ Â· í•©ê³„ ~${(totalCost||0).toLocaleString()}ì› / ìº¡ ${budgetCap.toLocaleString()}ì› Â· ìƒí•œê°€ ${debug.perPlaceCeil.toLocaleString()}ì›`;
    })();
  </script>
</body>
</html>